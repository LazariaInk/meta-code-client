<html>

<head>
    <meta content="text/html; charset=UTF-8" http-equiv="content-type">
    <link rel="stylesheet" type="text/css" href="/lessons/styles.css">
</head>

<body class="c17 doc-content">
    <h1 class="c11 c2">Stream-uri asincrone.</h1>
    <p class="c3"><span class="c8"></span></p>
    <p class="c11"><span class="c15">&Icirc;ncep&acirc;nd cu versiunea C# 8.0, &icirc;n C# au fost ad&#259;ugate
        </span><span class="c5">stream-urile asincrone</span><span class="c8">, care simplific&#259; lucrul cu fluxurile
            de date &icirc;n mod asincron. De&#537;i asincronitatea &icirc;n C# exist&#259; de mult timp, metodele
            asincrone permiteau p&acirc;n&#259; acum ob&#539;inerea unui singur obiect, atunci c&acirc;nd opera&#539;ia
            asincron&#259; era preg&#259;tit&#259; s&#259; furnizeze rezultatul. Pentru returnarea mai multor valori
            &icirc;n C# pot fi folosi&#539;i iteratori, dar ace&#537;tia au o natur&#259; sincron&#259;, blocheaz&#259;
            firul apelant &#537;i nu pot fi utiliza&#539;i &icirc;n context asincron. Stream-urile asincrone evit&#259;
            aceast&#259; problem&#259;, permi&#539;&acirc;nd ob&#539;inerea mai multor valori &#537;i returnarea
            acestora pe m&#259;sur&#259; ce sunt disponibile &icirc;n mod asincron.</span></p>
    <p class="c3"><span class="c8"></span></p>
    <p class="c11"><span class="c8">&Icirc;n esen&#539;&#259;, un stream asincron reprezint&#259; o metod&#259; care are
            trei caracteristici:</span></p>
    <p class="c3"><span class="c8"></span></p>
    <p class="c11"><span class="c15">1. Metoda are modificatorul </span><span class="c4 c16">async</span></p>
    <p class="c3"><span class="c8"></span></p>
    <p class="c11"><span class="c15">2. Metoda returneaz&#259; un obiect</span><span
            class="c5">&nbsp;IAsyncEnumerable&lt;T&gt;</span><span class="c8">. Interfa&#539;a IAsyncEnumerable
            define&#537;te metoda GetAsyncEnumerator, care returneaz&#259; IAsyncEnumerator:</span></p>
    <p class="c3"><span class="c8"></span></p><a id="t.f7e70629e2b29903a388e184fde2cbebe924e2d7"></a><a id="t.0"></a>
    <table class="c6">
        <tr class="c10">
            <td class="c14" colspan="1" rowspan="1">
                <p class="c7"><span class="c0">public</span><span class="c1">&nbsp;</span><span
                        class="c0">interface</span><span class="c1">&nbsp;</span><span
                        class="c9">IAsyncEnumerable</span><span class="c1">&lt;</span><span class="c9">out</span><span
                        class="c1">&nbsp;</span><span class="c9">T</span><span class="c1">&gt;<br>{<br> &nbsp;
                        &nbsp;IAsyncEnumerator&lt;T&gt; </span><span class="c9">GetAsyncEnumerator</span><span
                        class="c1">(CancellationToken cancellationToken = </span><span class="c0">default</span><span
                        class="c1">);<br>}<br> <br></span><span class="c0">public</span><span
                        class="c1">&nbsp;</span><span class="c0">interface</span><span class="c1">&nbsp;</span><span
                        class="c9">IAsyncEnumerator</span><span class="c1">&lt;</span><span class="c9">out</span><span
                        class="c1">&nbsp;</span><span class="c9">T</span><span class="c1">&gt; : </span><span
                        class="c9">IAsyncDisposable</span><span class="c1"><br>{<br> &nbsp; &nbsp;T Current {
                    </span><span class="c0">get</span><span class="c1">; }<br> &nbsp; &nbsp;ValueTask&lt;</span><span
                        class="c0">bool</span><span class="c1">&gt; </span><span class="c9">MoveNextAsync</span><span
                        class="c1">();<br>}<br> <br></span><span class="c0">public</span><span
                        class="c1">&nbsp;</span><span class="c0">interface</span><span class="c1">&nbsp;</span><span
                        class="c9">IAsyncDisposable</span><span class="c1"><br>{<br> &nbsp; &nbsp;ValueTask </span><span
                        class="c9">DisposeAsync</span><span class="c1">();<br>}</span></p>
            </td>
        </tr>
    </table>
    <p class="c3"><span class="c8"></span></p>
    <p class="c11"><span class="c15">3. Metoda con&#539;ine expresii</span><span class="c4">&nbsp;yield return
        </span><span class="c8">pentru ob&#539;inerea secven&#539;ial&#259; a elementelor din stream-ul asincron</span>
    </p>
    <p class="c3"><span class="c8"></span></p>
    <p class="c11"><span class="c8">De fapt, stream-ul asincron combin&#259; asincronitatea &#537;i iteratorii. S&#259;
            analiz&#259;m un exemplu simplu:</span></p>
    <p class="c3"><span class="c8"></span></p><a id="t.0585ed62443f1ef1827f10c401e01dde7807d624"></a><a id="t.1"></a>
    <table class="c6">
        <tr class="c10">
            <td class="c14" colspan="1" rowspan="1">
                <p class="c7"><span class="c0">await</span><span class="c1">&nbsp;</span><span
                        class="c0">foreach</span><span class="c1">&nbsp;(</span><span class="c0">var</span><span
                        class="c1">&nbsp;number </span><span class="c0">in</span><span class="c1">&nbsp;</span><span
                        class="c9">GetNumbersAsync</span><span class="c1">())<br>{<br> &nbsp;
                        &nbsp;Console.WriteLine(number);<br>}<br> <br></span><span class="c0">async</span><span
                        class="c1">&nbsp;IAsyncEnumerable&lt;</span><span class="c0">int</span><span class="c1">&gt;
                    </span><span class="c9">GetNumbersAsync</span><span class="c1">()<br>{<br> &nbsp; &nbsp;</span><span
                        class="c0">for</span><span class="c1">&nbsp;(</span><span class="c0">int</span><span
                        class="c1">&nbsp;i = </span><span class="c12">0</span><span class="c1">; i &lt; </span><span
                        class="c12">10</span><span class="c1">; i++)<br> &nbsp; &nbsp;{<br> &nbsp; &nbsp; &nbsp;
                        &nbsp;</span><span class="c0">await</span><span class="c1">&nbsp;Task.Delay(</span><span
                        class="c12">100</span><span class="c1">);<br> &nbsp; &nbsp; &nbsp; &nbsp;</span><span
                        class="c0">yield</span><span class="c1">&nbsp;</span><span class="c0">return</span><span
                        class="c1">&nbsp;i;<br> &nbsp; &nbsp;}<br>}</span></p>
            </td>
        </tr>
    </table>
    <p class="c3"><span class="c8"></span></p>
    <p class="c11"><span class="c15">Metoda </span><span class="c4">GetNumbersAsync()</span><span
            class="c15">&nbsp;reprezint&#259; de fapt un stream asincron. Aceast&#259; metod&#259; este asincron&#259;.
            Tipul s&#259;u returnat este</span><span class="c4">&nbsp;IAsyncEnumerable&lt;int&gt;</span><span
            class="c15">. Metoda returneaz&#259; cu ajutorul</span><span class="c4">&nbsp;yield return</span><span
            class="c8">&nbsp;c&acirc;te un num&#259;r la fiecare 100 de milisecunde. Astfel, metoda trebuie s&#259;
            returneze 10 numere de la 0 la 9 cu o pauz&#259; de 100 de milisecunde &icirc;ntre ele.</span></p>
    <p class="c3"><span class="c8"></span></p>
    <p class="c11"><span class="c8">Pentru a ob&#539;ine date din stream &icirc;n metoda Main, se folose&#537;te ciclul
            foreach:</span></p>
    <p class="c3"><span class="c8"></span></p><a id="t.cdbca2024b6486ca0c9c09c67658106dbf10a1c3"></a><a id="t.2"></a>
    <table class="c6">
        <tr class="c10">
            <td class="c14" colspan="1" rowspan="1">
                <p class="c7"><span class="c0">await</span><span class="c1">&nbsp;</span><span
                        class="c0">foreach</span><span class="c1">&nbsp;(</span><span class="c0">var</span><span
                        class="c1">&nbsp;number </span><span class="c0">in</span><span class="c1">&nbsp;</span><span
                        class="c9">GetNumbersAsync</span><span class="c1">())</span></p>
            </td>
        </tr>
    </table>
    <p class="c3"><span class="c8"></span></p>
    <p class="c11"><span class="c15">Este important de men&#539;ionat c&#259; ciclul este precedat de operatorul
        </span><span class="c5">await</span><span class="c8">. Astfel, de fiecare dat&#259; c&acirc;nd stream-ul
            asincron va returna un nou num&#259;r, ciclul &icirc;l va prelua &#537;i &icirc;l va afi&#537;a pe
            consol&#259;.</span></p>
    <p class="c3"><span class="c8"></span></p>
    <p class="c11"><span class="c8">Unde pot fi utilizate stream-urile asincrone? Stream-urile asincrone pot fi
            utilizate pentru ob&#539;inerea datelor dintr-un depozit extern. De exemplu, s&#259; presupunem c&#259; avem
            urm&#259;toarea clas&#259; a unui depozit:</span></p>
    <p class="c3"><span class="c8"></span></p><a id="t.3a6dfac53afcbec0053ad49b032235a01dcd181b"></a><a id="t.3"></a>
    <table class="c6">
        <tr class="c10">
            <td class="c14" colspan="1" rowspan="1">
                <p class="c7"><span class="c0">class</span><span class="c1">&nbsp;</span><span
                        class="c9">Repository</span><span class="c1"><br>{<br> &nbsp; &nbsp;</span><span
                        class="c0">string</span><span class="c1">[] data = { </span><span
                        class="c13">&quot;Tom&quot;</span><span class="c1">, </span><span
                        class="c13">&quot;Sam&quot;</span><span class="c1">, </span><span
                        class="c13">&quot;Kate&quot;</span><span class="c1">, </span><span
                        class="c13">&quot;Alice&quot;</span><span class="c1">, </span><span
                        class="c13">&quot;Bob&quot;</span><span class="c1">&nbsp;};<br> &nbsp; &nbsp;</span><span
                        class="c0">public</span><span class="c1">&nbsp;</span><span class="c0">async</span><span
                        class="c1">&nbsp;IAsyncEnumerable&lt;</span><span class="c0">string</span><span class="c1">&gt;
                    </span><span class="c9">GetDataAsync</span><span class="c1">()<br> &nbsp; &nbsp;{<br> &nbsp; &nbsp;
                        &nbsp; &nbsp;</span><span class="c0">for</span><span class="c1">&nbsp;(</span><span
                        class="c0">int</span><span class="c1">&nbsp;i = </span><span class="c12">0</span><span
                        class="c1">; i &lt; data.Length; i++)<br> &nbsp; &nbsp; &nbsp; &nbsp;{<br> &nbsp; &nbsp; &nbsp;
                        &nbsp; &nbsp; &nbsp;Console.WriteLine(</span><span class="c13">$&quot;Ob&#539;inem elementul {i
                        + </span><span class="c12">1</span><span class="c13">}&quot;</span><span class="c1">);<br>
                        &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c0">await</span><span
                        class="c1">&nbsp;Task.Delay(</span><span class="c12">500</span><span class="c1">);<br> &nbsp;
                        &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c0">yield</span><span
                        class="c1">&nbsp;</span><span class="c0">return</span><span class="c1">&nbsp;data[i];<br> &nbsp;
                        &nbsp; &nbsp; &nbsp;}<br> &nbsp; &nbsp;}<br>}</span></p>
            </td>
        </tr>
    </table>
    <p class="c3"><span class="c8"></span></p>
    <p class="c11"><span class="c8">Pentru simplificarea exemplului, datele sunt reprezentate aici sub forma unui simplu
            array intern de &#537;iruri de caractere. Pentru a imita &icirc;nt&acirc;rzierea &icirc;n ob&#539;inerea
            datelor, se folose&#537;te metoda Task.Delay.</span></p>
    <p class="c3"><span class="c8"></span></p>
    <p class="c11"><span class="c8">S&#259; ob&#539;inem aceste date &icirc;n program:</span></p>
    <p class="c3"><span class="c8"></span></p><a id="t.d549e40ca4d3bc331d95fd518887f41cc4f7f591"></a><a id="t.4"></a>
    <table class="c6">
        <tr class="c10">
            <td class="c14" colspan="1" rowspan="1">
                <p class="c7"><span class="c1">Repository repo = </span><span class="c0">new</span><span
                        class="c1">&nbsp;Repository();<br>IAsyncEnumerable&lt;</span><span class="c0">string</span><span
                        class="c1">&gt; data = repo.GetDataAsync();<br></span><span class="c0">await</span><span
                        class="c1">&nbsp;</span><span class="c0">foreach</span><span class="c1">&nbsp;(</span><span
                        class="c0">var</span><span class="c1">&nbsp;name </span><span class="c0">in</span><span
                        class="c1">&nbsp;data)<br>{<br> &nbsp; &nbsp;Console.WriteLine(name);<br>}<br><br></span><span
                        class="c0">class</span><span class="c1">&nbsp;</span><span class="c9">Repository</span><span
                        class="c1"><br>{<br> &nbsp; &nbsp;</span><span class="c0">string</span><span class="c1">[] data
                        = { </span><span class="c13">&quot;Tom&quot;</span><span class="c1">, </span><span
                        class="c13">&quot;Sam&quot;</span><span class="c1">, </span><span
                        class="c13">&quot;Kate&quot;</span><span class="c1">, </span><span
                        class="c13">&quot;Alice&quot;</span><span class="c1">, </span><span
                        class="c13">&quot;Bob&quot;</span><span class="c1">&nbsp;};<br> &nbsp; &nbsp;</span><span
                        class="c0">public</span><span class="c1">&nbsp;</span><span class="c0">async</span><span
                        class="c1">&nbsp;IAsyncEnumerable&lt;</span><span class="c0">string</span><span class="c1">&gt;
                    </span><span class="c9">GetDataAsync</span><span class="c1">()<br> &nbsp; &nbsp;{<br> &nbsp; &nbsp;
                        &nbsp; &nbsp;</span><span class="c0">for</span><span class="c1">&nbsp;(</span><span
                        class="c0">int</span><span class="c1">&nbsp;i = </span><span class="c12">0</span><span
                        class="c1">; i &lt; data.Length; i++)<br> &nbsp; &nbsp; &nbsp; &nbsp;{<br> &nbsp; &nbsp; &nbsp;
                        &nbsp; &nbsp; &nbsp;Console.WriteLine(</span><span class="c13">$&quot;Ob&#539;inem elementul {i
                        + </span><span class="c12">1</span><span class="c13">}&quot;</span><span class="c1">);<br>
                        &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c0">await</span><span
                        class="c1">&nbsp;Task.Delay(</span><span class="c12">500</span><span class="c1">);<br> &nbsp;
                        &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c0">yield</span><span
                        class="c1">&nbsp;</span><span class="c0">return</span><span class="c1">&nbsp;data[i];<br> &nbsp;
                        &nbsp; &nbsp; &nbsp;}<br> &nbsp; &nbsp;}<br>}</span></p>
            </td>
        </tr>
    </table>
    <p class="c3"><span class="c8"></span></p>
    <p class="c11"><span class="c8">&Icirc;n acest exemplu, se creeaz&#259; o instan&#539;&#259; a clasei Repository
            &#537;i se ob&#539;in datele asincron folosind metoda GetDataAsync(). Folosind await foreach, se
            itereaz&#259; prin elementele returnate de stream-ul asincron &#537;i se afi&#537;eaz&#259; pe
            consol&#259;.</span></p>
    <p class="c3"><span class="c8"></span></p>
</body>

</html>