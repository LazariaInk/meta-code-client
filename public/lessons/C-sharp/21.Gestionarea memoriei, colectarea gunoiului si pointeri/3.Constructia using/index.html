<html><head><meta content="text/html; charset=UTF-8" http-equiv="content-type"><link rel="stylesheet" type="text/css" href="/lessons/styles.css"></head><body class="c16 doc-content"><p class="c8"><span class="c15">Construc&#539;ia using.</span></p><p class="c4"><span class="c6"></span></p><p class="c8"><span class="c6">&Icirc;n tema anterioar&#259;, unde am discutat despre implementarea metodei Dispose, s-a men&#539;ionat c&#259; pentru a o apela putem folosi urm&#259;toarea construc&#539;ie try..finally:</span></p><p class="c4"><span class="c6"></span></p><a id="t.7ea254ad5d78bf505497447be709d49d7b2a115b"></a><a id="t.0"></a><table class="c0"><tr class="c12"><td class="c10" colspan="1" rowspan="1"><p class="c11"><span class="c1">Test();<br> <br></span><span class="c2">void</span><span class="c1">&nbsp;</span><span class="c7">Test</span><span class="c1">()<br>{<br> &nbsp; &nbsp;Person? tom = </span><span class="c2">null</span><span class="c1">;<br> &nbsp; &nbsp;</span><span class="c2">try</span><span class="c1"><br> &nbsp; &nbsp;{<br> &nbsp; &nbsp; &nbsp; &nbsp;tom = </span><span class="c2">new</span><span class="c1">&nbsp;Person(</span><span class="c5">&quot;Tom&quot;</span><span class="c1">);<br> &nbsp; &nbsp;}<br> &nbsp; &nbsp;</span><span class="c2">finally</span><span class="c1"><br> &nbsp; &nbsp;{<br> &nbsp; &nbsp; &nbsp; &nbsp;tom?.Dispose();<br> &nbsp; &nbsp;}<br>}<br></span><span class="c2">public</span><span class="c1">&nbsp;</span><span class="c2">class</span><span class="c1">&nbsp;</span><span class="c7">Person</span><span class="c1">&nbsp;: </span><span class="c7">IDisposable</span><span class="c1"><br>{<br> &nbsp; &nbsp;</span><span class="c2">public</span><span class="c1">&nbsp;</span><span class="c2">string</span><span class="c1">&nbsp;Name { </span><span class="c2">get</span><span class="c1">;}<br> &nbsp; &nbsp;</span><span class="c2">public</span><span class="c1">&nbsp;</span><span class="c7">Person</span><span class="c1">(</span><span class="c2">string</span><span class="c1">&nbsp;name) =&gt; Name = name;<br> <br> &nbsp; &nbsp;</span><span class="c2">public</span><span class="c1">&nbsp;</span><span class="c2">void</span><span class="c1">&nbsp;</span><span class="c7">Dispose</span><span class="c1">() =&gt; Console.WriteLine(</span><span class="c5">$&quot;{Name} has been disposed&quot;</span><span class="c1">);<br>}</span></p></td></tr></table><p class="c4"><span class="c6"></span></p><p class="c8"><span class="c9">Totu&#537;i, sintaxa C# ofer&#259; &#537;i o construc&#539;ie sinonimic&#259; pentru apelarea automat&#259; a metodei Dispose - construc&#539;ia </span><span class="c14">using</span><span class="c6">:</span></p><p class="c4"><span class="c6"></span></p><a id="t.fe5bd7cde37a11913b2f1851a4e82f26b52e5740"></a><a id="t.1"></a><table class="c0"><tr class="c12"><td class="c10" colspan="1" rowspan="1"><p class="c11"><span class="c2">using</span><span class="c1">&nbsp;(Person tom = </span><span class="c2">new</span><span class="c1">&nbsp;Person(</span><span class="c5">&quot;Tom&quot;</span><span class="c1">))<br>{<br>}</span></p></td></tr></table><p class="c4"><span class="c6"></span></p><p class="c8"><span class="c6">Construc&#539;ia using define&#537;te un bloc de cod &#537;i creeaz&#259; un obiect de un anumit tip, care implementeaz&#259; interfa&#539;a IDisposable, &icirc;n special metoda sa Dispose. La finalizarea blocului de cod, metoda Dispose este apelat&#259; automat pentru obiectul respectiv.</span></p><p class="c4"><span class="c6"></span></p><p class="c8"><span class="c6">Este important de men&#539;ionat c&#259; aceast&#259; construc&#539;ie se aplic&#259; doar pentru tipurile care implementeaz&#259; interfa&#539;a IDisposable.</span></p><p class="c4"><span class="c6"></span></p><p class="c8"><span class="c6">Utilizarea construc&#539;iei using:</span></p><p class="c4"><span class="c6"></span></p><a id="t.3f598ddd3f6a918161c8d259e1fb20c78b343e87"></a><a id="t.2"></a><table class="c0"><tr class="c12"><td class="c10" colspan="1" rowspan="1"><p class="c11"><span class="c1">Test();<br> <br></span><span class="c2">void</span><span class="c1">&nbsp;</span><span class="c7">Test</span><span class="c1">()<br>{<br> &nbsp; &nbsp;</span><span class="c2">using</span><span class="c1">&nbsp;(Person tom = </span><span class="c2">new</span><span class="c1">&nbsp;Person(</span><span class="c5">&quot;Tom&quot;</span><span class="c1">))<br> &nbsp; &nbsp;{<br> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c13">// variabila tom este disponibil&#259; doar &icirc;n blocul using</span><span class="c1"><br> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c13">// unele ac&#539;iuni cu obiectul Person</span><span class="c1"><br> &nbsp; &nbsp; &nbsp; &nbsp;Console.WriteLine(</span><span class="c5">$&quot;Name: {tom.Name}&quot;</span><span class="c1">);<br> &nbsp; &nbsp;}<br> &nbsp; &nbsp;Console.WriteLine(</span><span class="c5">&quot;Sf&acirc;r&#537;itul metodei Test&quot;</span><span class="c1">);<br>}<br></span><span class="c2">public</span><span class="c1">&nbsp;</span><span class="c2">class</span><span class="c1">&nbsp;</span><span class="c7">Person</span><span class="c1">&nbsp;: </span><span class="c7">IDisposable</span><span class="c1"><br>{<br> &nbsp; &nbsp;</span><span class="c2">public</span><span class="c1">&nbsp;</span><span class="c2">string</span><span class="c1">&nbsp;Name { </span><span class="c2">get</span><span class="c1">;}<br> &nbsp; &nbsp;</span><span class="c2">public</span><span class="c1">&nbsp;</span><span class="c7">Person</span><span class="c1">(</span><span class="c2">string</span><span class="c1">&nbsp;name) =&gt; Name = name;<br> <br> &nbsp; &nbsp;</span><span class="c2">public</span><span class="c1">&nbsp;</span><span class="c2">void</span><span class="c1">&nbsp;</span><span class="c7">Dispose</span><span class="c1">() =&gt; Console.WriteLine(</span><span class="c5">$&quot;{Name} has been disposed&quot;</span><span class="c1">);<br>}</span></p></td></tr></table><p class="c4"><span class="c6"></span></p><p class="c8"><span class="c6">Output &icirc;n consol&#259;:</span></p><p class="c4"><span class="c6"></span></p><a id="t.78765ea8ddba79b82adbc78284517dd959f18a4c"></a><a id="t.3"></a><table class="c0"><tr class="c12"><td class="c10" colspan="1" rowspan="1"><p class="c11"><span class="c1">Name: Tom<br>Tom has been disposed<br>Sf&acirc;r&#537;itul metodei Test</span></p></td></tr></table><p class="c4"><span class="c6"></span></p><p class="c8"><span class="c6">Aici observ&#259;m c&#259; la finalizarea blocului using, metoda Dispose este apelat&#259; pentru obiectul Person. &Icirc;n afara blocului de cod using, obiectul tom nu mai exist&#259;.</span></p><p class="c4"><span class="c6"></span></p><p class="c8"><span class="c6">&Icirc;ncep&acirc;nd cu versiunea C# 8.0, putem seta ca domeniul de aplicare s&#259; fie &icirc;ntreaga zon&#259; de vizibilitate, de exemplu, metoda:</span></p><p class="c4"><span class="c6"></span></p><a id="t.9c670a432e34566bc7d04e2197e020a55b4e6246"></a><a id="t.4"></a><table class="c0"><tr class="c12"><td class="c10" colspan="1" rowspan="1"><p class="c11"><span class="c1">Test();<br> <br></span><span class="c2">void</span><span class="c1">&nbsp;</span><span class="c7">Test</span><span class="c1">()<br>{<br> &nbsp; &nbsp;</span><span class="c2">using</span><span class="c1">&nbsp;Person tom = </span><span class="c2">new</span><span class="c1">&nbsp;Person(</span><span class="c5">&quot;Tom&quot;</span><span class="c1">);<br> &nbsp; &nbsp; <br> &nbsp; &nbsp;</span><span class="c13">// variabila tom este disponibil&#259; doar &icirc;n blocul using</span><span class="c1"><br> &nbsp; &nbsp;</span><span class="c13">// unele ac&#539;iuni cu obiectul Person</span><span class="c1"><br> &nbsp; &nbsp;Console.WriteLine(</span><span class="c5">$&quot;Name: {tom.Name}&quot;</span><span class="c1">);<br> &nbsp; &nbsp;Console.WriteLine(</span><span class="c5">&quot;Sf&acirc;r&#537;itul metodei Test&quot;</span><span class="c1">);<br>}<br></span><span class="c2">public</span><span class="c1">&nbsp;</span><span class="c2">class</span><span class="c1">&nbsp;</span><span class="c7">Person</span><span class="c1">&nbsp;: </span><span class="c7">IDisposable</span><span class="c1"><br>{<br> &nbsp; &nbsp;</span><span class="c2">public</span><span class="c1">&nbsp;</span><span class="c2">string</span><span class="c1">&nbsp;Name { </span><span class="c2">get</span><span class="c1">;}<br> &nbsp; &nbsp;</span><span class="c2">public</span><span class="c1">&nbsp;</span><span class="c7">Person</span><span class="c1">(</span><span class="c2">string</span><span class="c1">&nbsp;name) =&gt; Name = name;<br> <br> &nbsp; &nbsp;</span><span class="c2">public</span><span class="c1">&nbsp;</span><span class="c2">void</span><span class="c1">&nbsp;</span><span class="c7">Dispose</span><span class="c1">() =&gt; Console.WriteLine(</span><span class="c5">$&quot;{Name} has been disposed&quot;</span><span class="c1">);<br>}</span></p></td></tr></table><p class="c4"><span class="c6"></span></p><p class="c8"><span class="c6">&Icirc;n acest caz, using informeaz&#259; compilatorul c&#259; variabila declarat&#259; trebuie eliberat&#259; la sf&acirc;r&#537;itul domeniului de vizibilitate - adic&#259; la sf&acirc;r&#537;itul metodei Test. &Icirc;n consecin&#539;&#259;, output-ul &icirc;n consol&#259; va fi:</span></p><p class="c4"><span class="c6"></span></p><a id="t.ee38c96bd446b25d2a3859ea5d5536bad89b21d8"></a><a id="t.5"></a><table class="c0"><tr class="c12"><td class="c10" colspan="1" rowspan="1"><p class="c11"><span class="c1">Name: Tom<br>Sf&acirc;r&#537;itul metodei Test<br>Tom has been disposed</span></p></td></tr></table><p class="c4"><span class="c6"></span></p><p class="c8"><span class="c3">Eliberarea mai multor resurse.</span></p><p class="c4"><span class="c6"></span></p><p class="c8"><span class="c6">Pentru eliberarea mai multor resurse, putem folosi construc&#539;ii using imbricate. De exemplu:</span></p><p class="c4"><span class="c6"></span></p><a id="t.ad22db78effad872bf47184d7bfe25679ad5e451"></a><a id="t.6"></a><table class="c0"><tr class="c12"><td class="c10" colspan="1" rowspan="1"><p class="c11"><span class="c2">void</span><span class="c1">&nbsp;</span><span class="c7">Test</span><span class="c1">()<br>{<br> &nbsp; &nbsp;</span><span class="c2">using</span><span class="c1">&nbsp;(Person tom = </span><span class="c2">new</span><span class="c1">&nbsp;Person(</span><span class="c5">&quot;Tom&quot;</span><span class="c1">))<br> &nbsp; &nbsp;{<br> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c2">using</span><span class="c1">&nbsp;(Person bob = </span><span class="c2">new</span><span class="c1">&nbsp;Person(</span><span class="c5">&quot;Bob&quot;</span><span class="c1">))<br> &nbsp; &nbsp; &nbsp; &nbsp;{<br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Console.WriteLine(</span><span class="c5">$&quot;Person1: {tom.Name} &nbsp; &nbsp;Person2: {bob.Name}&quot;</span><span class="c1">);<br> &nbsp; &nbsp; &nbsp; &nbsp;} </span><span class="c13">// apelarea metodei Dispose pentru obiectul bob</span><span class="c1"><br> &nbsp; &nbsp;} </span><span class="c13">// apelarea metodei Dispose pentru obiectul tom</span><span class="c1"><br> &nbsp; &nbsp;Console.WriteLine(</span><span class="c5">&quot;Sf&acirc;r&#537;itul metodei Test&quot;</span><span class="c1">);<br>}</span></p></td></tr></table><p class="c4"><span class="c6"></span></p><p class="c8"><span class="c6">&Icirc;n acest caz, ambele construc&#539;ii using creeaz&#259; obiecte de acela&#537;i tip, dar pot fi &#537;i tipuri de date diferite, cu condi&#539;ia ca acestea s&#259; implementeze interfa&#539;a IDisposable.</span></p><p class="c4"><span class="c6"></span></p><p class="c8"><span class="c6">Putem simplifica aceast&#259; defini&#539;ie:</span></p><p class="c4"><span class="c6"></span></p><a id="t.d0c7ee9b768b3424e7cc2a60efe3e22e14df7e44"></a><a id="t.7"></a><table class="c0"><tr class="c12"><td class="c10" colspan="1" rowspan="1"><p class="c11"><span class="c2">void</span><span class="c1">&nbsp;</span><span class="c7">Test</span><span class="c1">()<br>{<br> &nbsp; &nbsp;</span><span class="c2">using</span><span class="c1">&nbsp;(Person tom = </span><span class="c2">new</span><span class="c1">&nbsp;Person(</span><span class="c5">&quot;Tom&quot;</span><span class="c1">))<br> &nbsp; &nbsp;</span><span class="c2">using</span><span class="c1">(Person bob = </span><span class="c2">new</span><span class="c1">&nbsp;Person(</span><span class="c5">&quot;Bob&quot;</span><span class="c1">))<br> &nbsp; &nbsp;{<br> &nbsp; &nbsp; &nbsp; &nbsp;Console.WriteLine(</span><span class="c5">$&quot;Person1: {tom.Name} &nbsp; &nbsp;Person2: {bob.Name}&quot;</span><span class="c1">);<br> &nbsp; &nbsp;} </span><span class="c13">// apelarea metodei Dispose pentru obiectele bob &#537;i tom</span><span class="c1"><br> &nbsp; &nbsp;Console.WriteLine(</span><span class="c5">&quot;Sf&acirc;r&#537;itul metodei Test&quot;</span><span class="c1">);<br>}</span></p></td></tr></table><p class="c4"><span class="c6"></span></p><p class="c8"><span class="c6">&#536;i, a&#537;a cum s-a men&#539;ionat anterior, &icirc;n C# putem seta ca domeniul de aplicare pentru obiectele create &icirc;n construc&#539;ia using s&#259; fie &icirc;ntreaga metod&#259;:</span></p><p class="c4"><span class="c6"></span></p><a id="t.23d89b36c8c0fb9e635ddd9f14ee2affa9a6545e"></a><a id="t.8"></a><table class="c0"><tr class="c12"><td class="c10" colspan="1" rowspan="1"><p class="c11"><span class="c2">private</span><span class="c1">&nbsp;</span><span class="c2">static</span><span class="c1">&nbsp;</span><span class="c2">void</span><span class="c1">&nbsp;</span><span class="c7">Test</span><span class="c1">()<br>{<br> &nbsp; &nbsp;</span><span class="c2">using</span><span class="c1">&nbsp;Person tom = </span><span class="c2">new</span><span class="c1">&nbsp;Person { Name = </span><span class="c5">&quot;Tom&quot;</span><span class="c1">&nbsp;};<br> &nbsp; &nbsp;</span><span class="c2">using</span><span class="c1">&nbsp;Person bob = </span><span class="c2">new</span><span class="c1">&nbsp;Person { Name = </span><span class="c5">&quot;Bob&quot;</span><span class="c1">&nbsp;};<br> &nbsp; &nbsp; <br> &nbsp; &nbsp;Console.WriteLine(</span><span class="c5">$&quot;Person1: {tom.Name} &nbsp; &nbsp;Person2: {bob.Name}&quot;</span><span class="c1">);<br> &nbsp; &nbsp; <br> &nbsp; &nbsp;Console.WriteLine(</span><span class="c5">&quot;Sf&acirc;r&#537;itul metodei Test&quot;</span><span class="c1">);<br>} </span><span class="c13">// apelarea metodei Dispose pentru obiectele bob &#537;i tom</span></p></td></tr></table><p class="c4"><span class="c6"></span></p><p class="c4"><span class="c6"></span></p></body></html>