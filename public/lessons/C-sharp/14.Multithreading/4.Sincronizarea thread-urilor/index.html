<html><head><meta content="text/html; charset=UTF-8" http-equiv="content-type"><link rel="stylesheet" type="text/css" href="/lessons/styles.css"></head><body class="c12 doc-content"><p class="c8"><span class="c15">Sincronizarea thread-urilor.</span></p><p class="c8 c13"><span class="c2"></span></p><p class="c8"><span class="c2">Deseori, &icirc;n thread-uri sunt utilizate anumite resurse partajate, comune pentru &icirc;ntreaga program&#259;. Acestea pot fi variabile comune, fi&#537;iere, alte resurse. De exemplu:</span></p><a id="t.88e44b204d2295e2deac5116839ac1ba3f782c34"></a><a id="t.0"></a><table class="c10"><tr class="c5"><td class="c4" colspan="1" rowspan="1"><p class="c6"><span class="c9">int</span><span class="c0">&nbsp;x = </span><span class="c1">0</span><span class="c0">;<br><br></span><span class="c3">// pornim cinci thread-uri</span><span class="c0"><br></span><span class="c9">for</span><span class="c0">&nbsp;(</span><span class="c9">int</span><span class="c0">&nbsp;i = </span><span class="c1">1</span><span class="c0">; i &lt; </span><span class="c1">6</span><span class="c0">; i++)<br>{<br> &nbsp; &nbsp;Thread myThread = </span><span class="c9">new</span><span class="c0">(Print);<br> &nbsp; &nbsp;myThread.Name = </span><span class="c14">$&quot;Thread {i}&quot;</span><span class="c0">; &nbsp; </span><span class="c3">// set&#259;m numele pentru fiecare thread</span><span class="c0"><br> &nbsp; &nbsp;myThread.Start();<br>}<br><br></span><span class="c9">void</span><span class="c0">&nbsp;</span><span class="c11">Print</span><span class="c0">()<br>{<br> &nbsp; &nbsp;x = </span><span class="c1">1</span><span class="c0">;<br> &nbsp; &nbsp;</span><span class="c9">for</span><span class="c0">&nbsp;(</span><span class="c9">int</span><span class="c0">&nbsp;i = </span><span class="c1">1</span><span class="c0">; i &lt; </span><span class="c1">6</span><span class="c0">; i++)<br> &nbsp; &nbsp;{<br> &nbsp; &nbsp; &nbsp; &nbsp;Console.WriteLine(</span><span class="c14">$&quot;{Thread.CurrentThread.Name}: {x}&quot;</span><span class="c0">);<br> &nbsp; &nbsp; &nbsp; &nbsp;x++;<br> &nbsp; &nbsp; &nbsp; &nbsp;Thread.Sleep(</span><span class="c1">100</span><span class="c0">);<br> &nbsp; &nbsp;}<br>}</span></p></td></tr></table><p class="c8 c13"><span class="c2"></span></p><p class="c8"><span class="c2">Aici pornim cinci thread-uri care apeleaz&#259; metoda Print &#537;i care lucreaz&#259; cu variabila comun&#259; x. Ne a&#537;tept&#259;m ca metoda s&#259; afi&#537;eze toate valorile x de la 1 la 5 pentru fiecare thread. Totu&#537;i, &icirc;n realitate, &icirc;n timpul execu&#539;iei, va avea loc comutarea &icirc;ntre thread-uri, iar valoarea variabilei x devine imprevizibil&#259;. De exemplu, &icirc;n cazul meu, am ob&#539;inut urm&#259;toarea ie&#537;ire pe consol&#259; (poate varia &icirc;n func&#539;ie de fiecare caz):</span></p><p class="c8 c13"><span class="c2"></span></p><a id="t.1d1c5876202e801cc4816a4c9425894a86b6f0bb"></a><a id="t.1"></a><table class="c10"><tr class="c5"><td class="c4" colspan="1" rowspan="1"><p class="c6"><span class="c0">Thread </span><span class="c1">1</span><span class="c0">: </span><span class="c1">1</span><span class="c0"><br>Thread </span><span class="c1">5</span><span class="c0">: </span><span class="c1">1</span><span class="c0"><br>Thread </span><span class="c1">4</span><span class="c0">: </span><span class="c1">1</span><span class="c0"><br>Thread </span><span class="c1">2</span><span class="c0">: </span><span class="c1">1</span><span class="c0"><br>Thread </span><span class="c1">3</span><span class="c0">: </span><span class="c1">1</span><span class="c0"><br>Thread </span><span class="c1">1</span><span class="c0">: </span><span class="c1">6</span><span class="c0"><br>Thread </span><span class="c1">5</span><span class="c0">: </span><span class="c1">7</span><span class="c0"><br>Thread </span><span class="c1">3</span><span class="c0">: </span><span class="c1">7</span><span class="c0"><br>Thread </span><span class="c1">2</span><span class="c0">: </span><span class="c1">7</span><span class="c0"><br>Thread </span><span class="c1">4</span><span class="c0">: </span><span class="c1">9</span><span class="c0"><br>Thread </span><span class="c1">1</span><span class="c0">: </span><span class="c1">11</span><span class="c0"><br>Thread </span><span class="c1">4</span><span class="c0">: </span><span class="c1">11</span><span class="c0"><br>Thread </span><span class="c1">2</span><span class="c0">: </span><span class="c1">11</span><span class="c0"><br>Thread </span><span class="c1">3</span><span class="c0">: </span><span class="c1">14</span><span class="c0"><br>Thread </span><span class="c1">5</span><span class="c0">: </span><span class="c1">11</span><span class="c0"><br>Thread </span><span class="c1">1</span><span class="c0">: </span><span class="c1">16</span><span class="c0"><br>Thread </span><span class="c1">2</span><span class="c0">: </span><span class="c1">16</span><span class="c0"><br>Thread </span><span class="c1">3</span><span class="c0">: </span><span class="c1">16</span><span class="c0"><br>Thread </span><span class="c1">5</span><span class="c0">: </span><span class="c1">18</span><span class="c0"><br>Thread </span><span class="c1">4</span><span class="c0">: </span><span class="c1">16</span><span class="c0"><br>Thread </span><span class="c1">1</span><span class="c0">: </span><span class="c1">21</span><span class="c0"><br>Thread </span><span class="c1">5</span><span class="c0">: </span><span class="c1">21</span><span class="c0"><br>Thread </span><span class="c1">3</span><span class="c0">: </span><span class="c1">21</span><span class="c0"><br>Thread </span><span class="c1">2</span><span class="c0">: </span><span class="c1">21</span><span class="c0"><br>Thread </span><span class="c1">4</span><span class="c0">: </span><span class="c1">21</span></p></td></tr></table><p class="c8 c13"><span class="c2"></span></p><p class="c8"><span class="c16">Solu&#539;ia problemei const&#259; &icirc;n sincronizarea thread-urilor &#537;i restric&#539;ionarea accesului la resursele partajate &icirc;n timpul utiliz&#259;rii acestora de c&#259;tre un thread. Pentru aceasta, se folose&#537;te cuv&acirc;ntul cheie </span><span class="c7">lock</span><span class="c16">. Operatorul </span><span class="c7">lock </span><span class="c2">define&#537;te un bloc de cod, &icirc;n interiorul c&#259;ruia tot codul este blocat &#537;i devine inaccesibil pentru alte thread-uri p&acirc;n&#259; la finalizarea execu&#539;iei thread-ului curent. Celelalte thread-uri sunt puse &icirc;ntr-o coad&#259; de a&#537;teptare &#537;i a&#537;teapt&#259; p&acirc;n&#259; c&acirc;nd thread-ul curent elibereaz&#259; acest bloc de cod. Astfel, cu ajutorul lock, putem modifica exemplul anterior astfel:</span></p><p class="c8 c13"><span class="c2"></span></p><a id="t.7b897154188d46b449bf96acc2ffd27b541408e8"></a><a id="t.2"></a><table class="c10"><tr class="c5"><td class="c4" colspan="1" rowspan="1"><p class="c6"><span class="c9">int</span><span class="c0">&nbsp;x = </span><span class="c1">0</span><span class="c0">;<br></span><span class="c9">object</span><span class="c0">&nbsp;locker = </span><span class="c9">new</span><span class="c0">(); &nbsp;</span><span class="c3">// obiect placeholder</span><span class="c0"><br><br></span><span class="c3">// pornim cinci thread-uri</span><span class="c0"><br></span><span class="c9">for</span><span class="c0">&nbsp;(</span><span class="c9">int</span><span class="c0">&nbsp;i = </span><span class="c1">1</span><span class="c0">; i &lt; </span><span class="c1">6</span><span class="c0">; i++)<br>{<br> &nbsp; &nbsp;Thread myThread = </span><span class="c9">new</span><span class="c0">(Print);<br> &nbsp; &nbsp;myThread.Name = </span><span class="c14">$&quot;Thread {i}&quot;</span><span class="c0">;<br> &nbsp; &nbsp;myThread.Start();<br>}<br><br></span><span class="c9">void</span><span class="c0">&nbsp;</span><span class="c11">Print</span><span class="c0">()<br>{<br> &nbsp; &nbsp;</span><span class="c9">lock</span><span class="c0">&nbsp;(locker)<br> &nbsp; &nbsp;{<br> &nbsp; &nbsp; &nbsp; &nbsp;x = </span><span class="c1">1</span><span class="c0">;<br> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c9">for</span><span class="c0">&nbsp;(</span><span class="c9">int</span><span class="c0">&nbsp;i = </span><span class="c1">1</span><span class="c0">; i &lt; </span><span class="c1">6</span><span class="c0">; i++)<br> &nbsp; &nbsp; &nbsp; &nbsp;{<br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Console.WriteLine(</span><span class="c14">$&quot;{Thread.CurrentThread.Name}: {x}&quot;</span><span class="c0">);<br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;x++;<br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Thread.Sleep(</span><span class="c1">100</span><span class="c0">);<br> &nbsp; &nbsp; &nbsp; &nbsp;}<br> &nbsp; &nbsp;}<br>}</span></p></td></tr></table><p class="c8 c13"><span class="c2"></span></p><p class="c8"><span class="c2">Pentru blocare, cuv&acirc;ntul cheie lock folose&#537;te un obiect placeholder, &icirc;n acest caz, variabila locker. De obicei, aceasta este o variabil&#259; de tip object. C&acirc;nd execu&#539;ia ajunge la operatorul lock, obiectul locker este blocat, &#537;i pe durata bloc&#259;rii, accesul exclusiv la blocul de cod este asigurat doar pentru un singur thread. Dup&#259; finalizarea execu&#539;iei blocului de cod, obiectul locker este eliberat &#537;i devine accesibil pentru alte thread-uri.</span></p><p class="c8 c13"><span class="c2"></span></p><p class="c8"><span class="c2">&Icirc;n acest caz, ie&#537;irea pe consol&#259; va fi mai ordonat&#259;:</span></p><p class="c8 c13"><span class="c2"></span></p><a id="t.9ba57c21e9e6718e9ffc70dca3d3b24b360dc4c7"></a><a id="t.3"></a><table class="c10"><tr class="c5"><td class="c4" colspan="1" rowspan="1"><p class="c6"><span class="c0">Thread </span><span class="c1">1</span><span class="c0">: </span><span class="c1">1</span><span class="c0"><br>Thread </span><span class="c1">1</span><span class="c0">: </span><span class="c1">2</span><span class="c0"><br>Thread </span><span class="c1">1</span><span class="c0">: </span><span class="c1">3</span><span class="c0"><br>Thread </span><span class="c1">1</span><span class="c0">: </span><span class="c1">4</span><span class="c0"><br>Thread </span><span class="c1">1</span><span class="c0">: </span><span class="c1">5</span><span class="c0"><br>Thread </span><span class="c1">5</span><span class="c0">: </span><span class="c1">1</span><span class="c0"><br>Thread </span><span class="c1">5</span><span class="c0">: </span><span class="c1">2</span><span class="c0"><br>Thread </span><span class="c1">5</span><span class="c0">: </span><span class="c1">3</span><span class="c0"><br>Thread </span><span class="c1">5</span><span class="c0">: </span><span class="c1">4</span><span class="c0"><br>Thread </span><span class="c1">5</span><span class="c0">: </span><span class="c1">5</span><span class="c0"><br>Thread </span><span class="c1">3</span><span class="c0">: </span><span class="c1">1</span><span class="c0"><br>Thread </span><span class="c1">3</span><span class="c0">: </span><span class="c1">2</span><span class="c0"><br>Thread </span><span class="c1">3</span><span class="c0">: </span><span class="c1">3</span><span class="c0"><br>Thread </span><span class="c1">3</span><span class="c0">: </span><span class="c1">4</span><span class="c0"><br>Thread </span><span class="c1">3</span><span class="c0">: </span><span class="c1">5</span><span class="c0"><br>Thread </span><span class="c1">2</span><span class="c0">: </span><span class="c1">1</span><span class="c0"><br>Thread </span><span class="c1">2</span><span class="c0">: </span><span class="c1">2</span><span class="c0"><br>Thread </span><span class="c1">2</span><span class="c0">: </span><span class="c1">3</span><span class="c0"><br>Thread </span><span class="c1">2</span><span class="c0">: </span><span class="c1">4</span><span class="c0"><br>Thread </span><span class="c1">2</span><span class="c0">: </span><span class="c1">5</span><span class="c0"><br>Thread </span><span class="c1">4</span><span class="c0">: </span><span class="c1">1</span><span class="c0"><br>Thread </span><span class="c1">4</span><span class="c0">: </span><span class="c1">2</span><span class="c0"><br>Thread </span><span class="c1">4</span><span class="c0">: </span><span class="c1">3</span><span class="c0"><br>Thread </span><span class="c1">4</span><span class="c0">: </span><span class="c1">4</span><span class="c0"><br>Thread </span><span class="c1">4</span><span class="c0">: </span><span class="c1">5</span></p></td></tr></table><p class="c8 c13"><span class="c2"></span></p><p class="c8 c13"><span class="c2"></span></p></body></html>