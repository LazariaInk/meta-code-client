<html><head><meta content="text/html; charset=UTF-8" http-equiv="content-type"><link rel="stylesheet" type="text/css" href="/lessons/styles.css"></head><body class="c18 doc-content"><p class="c8"><span class="c19">Serializarea &icirc;n JSON cu JsonSerializer. &nbsp;</span></p><p class="c1"><span class="c3"></span></p><p class="c8"><span class="c0">JSON </span><span class="c3">(JavaScript Object Notation) este unul dintre cele mai populare formate pentru stocarea &#537;i transferul datelor. Platforma .NET ofer&#259; func&#539;ionalit&#259;&#539;i pentru lucrul cu JSON.</span></p><p class="c1"><span class="c3"></span></p><p class="c8"><span class="c6">Func&#539;ionalitatea principal&#259; pentru lucrul cu JSON este concentrat&#259; &icirc;n spa&#539;iul de nume </span><span class="c0">System.Text.Json</span><span class="c6">. Tipul cheie este clasa </span><span class="c0">JsonSerializer</span><span class="c3">, care permite serializarea unui obiect &icirc;n JSON &#537;i, invers, deserializarea codului JSON &icirc;ntr-un obiect C#.</span></p><p class="c1"><span class="c3"></span></p><p class="c8"><span class="c6">Pentru a salva un obiect &icirc;n JSON, clasa </span><span class="c6">JsonSerializer </span><span class="c6">define&#537;te metoda static&#259; </span><span class="c0">Serialize()</span><span class="c6">&nbsp;&#537;i versiunea sa asincron&#259; </span><span class="c0">SerializeAsync()</span><span class="c3">, care au mai multe versiuni supra&icirc;nc&#259;rcate. C&acirc;teva dintre acestea sunt:</span></p><p class="c1"><span class="c3"></span></p><p class="c8"><span class="c6">-</span><span class="c6 c7">&nbsp;string Serialize(Object obj, Type type, JsonSerializerOptions options)</span><span class="c3">: serializ&#259; un obiect obj de tip type &#537;i returneaz&#259; codul JSON ca &#537;ir de caractere. Parametrul op&#539;ional options permite setarea unor op&#539;iuni suplimentare de serializare.</span></p><p class="c1"><span class="c3"></span></p><p class="c8"><span class="c6">-</span><span class="c6 c7">&nbsp;string Serialize&lt;T&gt;(T obj, JsonSerializerOptions options)</span><span class="c3">: o versiune tipizat&#259; care serializ&#259; un obiect obj de tip T &#537;i returneaz&#259; codul JSON ca &#537;ir de caractere.</span></p><p class="c1"><span class="c3"></span></p><p class="c8"><span class="c6">- </span><span class="c6 c7">Task SerializeAsync(Stream utf8Json, Object obj, Type type, JsonSerializerOptions options)</span><span class="c3">: serializ&#259; un obiect obj de tip type &#537;i &icirc;l scrie &icirc;ntr-un flux utf8Json. Parametrul op&#539;ional options permite setarea unor op&#539;iuni suplimentare de serializare.</span></p><p class="c1"><span class="c3"></span></p><p class="c8"><span class="c6">- </span><span class="c6 c7">Task SerializeAsync&lt;T&gt;(Stream utf8Json, T obj, JsonSerializerOptions options)</span><span class="c3">: o versiune tipizat&#259; care serializ&#259; un obiect obj de tip T &icirc;ntr-un flux utf8Json.</span></p><p class="c1"><span class="c3"></span></p><p class="c8"><span class="c6">Pentru deserializarea codului JSON &icirc;ntr-un obiect C#, se utilizeaz&#259; metoda </span><span class="c0">Deserialize()</span><span class="c6">&nbsp;&#537;i versiunea sa asincron&#259;</span><span class="c0">&nbsp;DeserializeAsync()</span><span class="c3">, care au diferite versiuni. C&acirc;teva dintre acestea sunt:</span></p><p class="c1"><span class="c3"></span></p><p class="c8"><span class="c3">- object? Deserialize(string json, Type type, JsonSerializerOptions options): deserializ&#259; un &#537;ir JSON &icirc;ntr-un obiect de tip type &#537;i returneaz&#259; obiectul deserializat. Parametrul op&#539;ional options permite setarea unor op&#539;iuni suplimentare de deserializare.</span></p><p class="c1"><span class="c3"></span></p><p class="c8"><span class="c6">-</span><span class="c6 c7">&nbsp;T? Deserialize&lt;T&gt;(string json, JsonSerializerOptions options)</span><span class="c3">: deserializ&#259; un &#537;ir JSON &icirc;ntr-un obiect de tip T &#537;i returneaz&#259; acest obiect.</span></p><p class="c1"><span class="c3"></span></p><p class="c8"><span class="c6">-</span><span class="c6 c7">&nbsp;ValueTask&lt;object?&gt; DeserializeAsync(Stream utf8Json, Type type, JsonSerializerOptions options, CancellationToken token)</span><span class="c3">: deserializ&#259; datele dintr-un flux utf8Json, care reprezint&#259; un obiect JSON, &icirc;ntr-un obiect de tip type. Parametrii op&#539;ionali options &#537;i token permit setarea unor op&#539;iuni suplimentare de deserializare &#537;i anularea sarcinii.</span></p><p class="c1"><span class="c3"></span></p><p class="c8"><span class="c6">- </span><span class="c6 c7">ValueTask&lt;T?&gt; DeserializeAsync&lt;T&gt;(Stream utf8Json, JsonSerializerOptions options, CancellationToken token)</span><span class="c3">: deserializ&#259; datele dintr-un flux utf8Json, care reprezint&#259; un obiect JSON, &icirc;ntr-un obiect de tip T.</span></p><p class="c1"><span class="c3"></span></p><p class="c8"><span class="c3">S&#259; vedem un exemplu simplu de serializare &#537;i deserializare a unui obiect:</span></p><p class="c1"><span class="c3"></span></p><a id="t.fceece500e127e7fa08e36c511278edc99e0501e"></a><a id="t.0"></a><table class="c11"><tr class="c17"><td class="c16" colspan="1" rowspan="1"><p class="c12"><span class="c5">using</span><span class="c2">&nbsp;System.Text.Json;<br><br>Person tom = </span><span class="c5">new</span><span class="c2">&nbsp;Person(</span><span class="c4">&quot;Tom&quot;</span><span class="c2">, </span><span class="c9">37</span><span class="c2">);<br></span><span class="c5">string</span><span class="c2">&nbsp;json = JsonSerializer.Serialize(tom);<br>Console.WriteLine(json);<br>Person? restoredPerson = JsonSerializer.Deserialize&lt;Person&gt;(json);<br>Console.WriteLine(restoredPerson?.Name); </span><span class="c10">// Tom</span><span class="c2"><br><br></span><span class="c5">class</span><span class="c2">&nbsp;</span><span class="c15">Person</span><span class="c2"><br>{<br> &nbsp; &nbsp;</span><span class="c5">public</span><span class="c2">&nbsp;</span><span class="c5">string</span><span class="c2">&nbsp;Name { </span><span class="c5">get</span><span class="c2">; }<br> &nbsp; &nbsp;</span><span class="c5">public</span><span class="c2">&nbsp;</span><span class="c5">int</span><span class="c2">&nbsp;Age { </span><span class="c5">get</span><span class="c2">; </span><span class="c5">set</span><span class="c2">; }<br> &nbsp; &nbsp;</span><span class="c5">public</span><span class="c2">&nbsp;</span><span class="c15">Person</span><span class="c2">(</span><span class="c5">string</span><span class="c2">&nbsp;name, </span><span class="c5">int</span><span class="c2">&nbsp;age)<br> &nbsp; &nbsp;{<br> &nbsp; &nbsp; &nbsp; &nbsp;Name = name;<br> &nbsp; &nbsp; &nbsp; &nbsp;Age = age;<br> &nbsp; &nbsp;}<br>}</span></p></td></tr></table><p class="c1"><span class="c3"></span></p><p class="c8"><span class="c6">&Icirc;n acest exemplu, serializ&#259;m obiectul de tip Person &icirc;ntr-un &#537;ir JSON folosind metoda </span><span class="c6 c7">JsonSerializer.Serialize()</span><span class="c6">. Apoi, restaur&#259;m acest obiect din &#537;irul JSON folosind metoda </span><span class="c6 c7">JsonSerializer.Deserialize()</span><span class="c3">.</span></p><p class="c1"><span class="c3"></span></p><p class="c8"><span class="c3">Ie&#537;irea &icirc;n consol&#259;:</span></p><p class="c1"><span class="c3"></span></p><a id="t.ea527342ea3bafdeca875f29eac08db9fe1f2234"></a><a id="t.1"></a><table class="c11"><tr class="c17"><td class="c16" colspan="1" rowspan="1"><p class="c12"><span class="c2">{</span><span class="c4">&quot;Name&quot;</span><span class="c2">:</span><span class="c4">&quot;Tom&quot;</span><span class="c2">,</span><span class="c4">&quot;Age&quot;</span><span class="c2">:</span><span class="c9">37</span><span class="c2">}<br>Tom</span></p></td></tr></table><p class="c1"><span class="c3"></span></p><p class="c8"><span class="c3">De&#537;i &icirc;n exemplul de mai sus s-a serializat/deserializat un obiect de clas&#259;, putem serializa/deserializa &#537;i structuri &icirc;n mod similar.</span></p><p class="c1"><span class="c3"></span></p><p class="c8"><span class="c14">Observa&#539;ii privind serializarea/deserializarea.</span></p><p class="c1"><span class="c3"></span></p><p class="c8"><span class="c3">Obiectul care urmeaz&#259; s&#259; fie deserializat trebuie s&#259; aib&#259; fie un constructor f&#259;r&#259; parametri, fie un constructor pentru care exist&#259; valori corespunz&#259;toare pentru to&#539;i parametrii &icirc;n obiectul JSON deserializat (coresponden&#539;a &icirc;ntre parametrii constructorului &#537;i propriet&#259;&#539;ile obiectului JSON este stabilit&#259; pe baza denumirilor, ignor&acirc;ndu-se sensibilitatea la majuscule). Doar propriet&#259;&#539;ile publice ale obiectului (cu modificatorul public) sunt serializate.</span></p><p class="c1"><span class="c3"></span></p><p class="c8"><span class="c14">Scrierea &#537;i citirea fi&#537;ierelor JSON.</span></p><p class="c1"><span class="c3"></span></p><p class="c8"><span class="c3">Deoarece metodele SerializeAsync/DeserializeAsync pot primi un flux de tip Stream, putem utiliza un flux de fi&#537;iere pentru a salva &#537;i extrage datele ulterior:</span></p><p class="c1"><span class="c3"></span></p><a id="t.01d5c15ad066332b34524b6a920e3ef4472828c2"></a><a id="t.2"></a><table class="c11"><tr class="c17"><td class="c16" colspan="1" rowspan="1"><p class="c12"><span class="c5">using</span><span class="c2">&nbsp;System.Text.Json;<br><br></span><span class="c10">// salvarea datelor</span><span class="c2"><br></span><span class="c5">using</span><span class="c2">&nbsp;(FileStream fs = </span><span class="c5">new</span><span class="c2">&nbsp;FileStream(</span><span class="c4">&quot;user.json&quot;</span><span class="c2">, FileMode.OpenOrCreate))<br>{<br> &nbsp; &nbsp;Person tom = </span><span class="c5">new</span><span class="c2">&nbsp;Person(</span><span class="c4">&quot;Tom&quot;</span><span class="c2">, </span><span class="c9">37</span><span class="c2">);<br> &nbsp; &nbsp;</span><span class="c5">await</span><span class="c2">&nbsp;JsonSerializer.SerializeAsync&lt;Person&gt;(fs, tom);<br> &nbsp; &nbsp;Console.WriteLine(</span><span class="c4">&quot;Datele au fost salvate &icirc;n fi&#537;ier&quot;</span><span class="c2">);<br>}<br><br></span><span class="c10">// citirea datelor</span><span class="c2"><br></span><span class="c5">using</span><span class="c2">&nbsp;(FileStream fs = </span><span class="c5">new</span><span class="c2">&nbsp;FileStream(</span><span class="c4">&quot;user.json&quot;</span><span class="c2">, FileMode.OpenOrCreate))<br>{<br> &nbsp; &nbsp;Person? person = </span><span class="c5">await</span><span class="c2">&nbsp;JsonSerializer.DeserializeAsync&lt;Person&gt;(fs);<br> &nbsp; &nbsp;Console.WriteLine(</span><span class="c4">$&quot;Nume: {person?.Name} &nbsp;V&acirc;rst&#259;: {person?.Age}&quot;</span><span class="c2">);<br>}<br><br></span><span class="c5">class</span><span class="c2">&nbsp;</span><span class="c15">Person</span><span class="c2"><br>{<br> &nbsp; &nbsp;</span><span class="c5">public</span><span class="c2">&nbsp;</span><span class="c5">string</span><span class="c2">&nbsp;Name { </span><span class="c5">get</span><span class="c2">; }<br> &nbsp; &nbsp;</span><span class="c5">public</span><span class="c2">&nbsp;</span><span class="c5">int</span><span class="c2">&nbsp;Age { </span><span class="c5">get</span><span class="c2">; </span><span class="c5">set</span><span class="c2">; }<br> &nbsp; &nbsp;</span><span class="c5">public</span><span class="c2">&nbsp;</span><span class="c15">Person</span><span class="c2">(</span><span class="c5">string</span><span class="c2">&nbsp;name, </span><span class="c5">int</span><span class="c2">&nbsp;age)<br> &nbsp; &nbsp;{<br> &nbsp; &nbsp; &nbsp; &nbsp;Name = name;<br> &nbsp; &nbsp; &nbsp; &nbsp;Age = age;<br> &nbsp; &nbsp;}<br>}</span></p></td></tr></table><p class="c1"><span class="c3"></span></p><p class="c8"><span class="c3">&Icirc;n acest exemplu, datele sunt salvate mai &icirc;nt&acirc;i &icirc;ntr-un fi&#537;ier user.json &#537;i apoi sunt citite din acesta.</span></p><p class="c1"><span class="c3"></span></p><p class="c8"><span class="c14">Configurarea serializ&#259;rii cu JsonSerializerOptions.</span></p><p class="c1"><span class="c3"></span></p><p class="c8"><span class="c6">&Icirc;n mod implicit, JsonSerializer serializ&#259; obiectele &icirc;ntr-un cod minimizat. Cu ajutorul parametrului suplimentar de tip </span><span class="c0">JsonSerializerOptions</span><span class="c3">, putem personaliza mecanismul de serializare/deserializare folosind propriet&#259;&#539;ile JsonSerializerOptions. C&acirc;teva dintre propriet&#259;&#539;ile sale sunt:</span></p><p class="c1"><span class="c3"></span></p><p class="c8"><span class="c6">- </span><span class="c0">AllowTrailingCommas</span><span class="c3">: stabile&#537;te dac&#259; trebuie ad&#259;ugat&#259; o virgul&#259; dup&#259; ultimul element din JSON. Dac&#259; valoarea este true, se adaug&#259; o virgul&#259;.</span></p><p class="c1"><span class="c3"></span></p><p class="c8"><span class="c6">- </span><span class="c0">DefaultIgnoreCondition</span><span class="c3">: stabile&#537;te dac&#259; propriet&#259;&#539;ile cu valori implicite trebuie serializate/deserializate &icirc;n JSON.</span></p><p class="c1"><span class="c3"></span></p><p class="c8"><span class="c6">- </span><span class="c0">IgnoreReadOnlyProperties</span><span class="c3">: stabile&#537;te dac&#259; propriet&#259;&#539;ile doar pentru citire trebuie serializate.</span></p><p class="c1"><span class="c3"></span></p><p class="c8"><span class="c6">- </span><span class="c0">WriteIndented</span><span class="c3">: stabile&#537;te dac&#259; trebuie ad&#259;ugate spa&#539;ii &icirc;n JSON (pentru lizibilitate). Dac&#259; valoarea este true, se adaug&#259; spa&#539;ii suplimentare.</span></p><p class="c1"><span class="c3"></span></p><p class="c8"><span class="c3">Exemplu de utilizare:</span></p><p class="c1"><span class="c3"></span></p><a id="t.3d98366be74d5f87b2885d14cc93adb43fc24d36"></a><a id="t.3"></a><table class="c11"><tr class="c17"><td class="c16" colspan="1" rowspan="1"><p class="c12"><span class="c5">using</span><span class="c2">&nbsp;System.Text.Json;<br><br>Person tom = </span><span class="c5">new</span><span class="c2">&nbsp;Person(</span><span class="c4">&quot;Tom&quot;</span><span class="c2">, </span><span class="c9">37</span><span class="c2">);<br><br></span><span class="c5">var</span><span class="c2">&nbsp;options = </span><span class="c5">new</span><span class="c2">&nbsp;JsonSerializerOptions<br>{<br> &nbsp; &nbsp;WriteIndented = </span><span class="c5">true</span><span class="c2"><br>};<br></span><span class="c5">string</span><span class="c2">&nbsp;json = JsonSerializer.Serialize&lt;Person&gt;(tom, options);<br>Console.WriteLine(json);<br>Person? restoredPerson = JsonSerializer.Deserialize&lt;Person&gt;(json);<br>Console.WriteLine(restoredPerson?.Name);</span></p></td></tr></table><p class="c1"><span class="c3"></span></p><p class="c8"><span class="c3">Ie&#537;irea &icirc;n consol&#259;:</span></p><p class="c1"><span class="c3"></span></p><a id="t.8423849a158147393c600fcee2804f578b5ae557"></a><a id="t.4"></a><table class="c11"><tr class="c17"><td class="c16" colspan="1" rowspan="1"><p class="c12"><span class="c2">{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c4">&quot;Name&quot;</span><span class="c2">: </span><span class="c4">&quot;Tom&quot;</span><span class="c2">,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c4">&quot;Age&quot;</span><span class="c2">: &nbsp;</span><span class="c9">37</span><span class="c2"><br>}<br>Tom</span></p></td></tr></table><p class="c1"><span class="c3"></span></p><p class="c8"><span class="c14">Configurarea serializ&#259;rii cu ajutorul atributelor.</span></p><p class="c1"><span class="c3"></span></p><p class="c8"><span class="c6">&Icirc;n mod implicit, toate propriet&#259;&#539;ile publice sunt serializate. &Icirc;n plus, &icirc;n obiectul JSON de ie&#537;ire, toate denumirile propriet&#259;&#539;ilor corespund denumirilor propriet&#259;&#539;ilor obiectului C#. Cu toate acestea, folosind atributele </span><span class="c0">JsonIgnore </span><span class="c6">&#537;i </span><span class="c0">JsonPropertyName</span><span class="c3">, putem ajusta acest comportament.</span></p><p class="c1"><span class="c3"></span></p><p class="c8"><span class="c6">- </span><span class="c0">JsonIgnore</span><span class="c3">: permite excluderea unei propriet&#259;&#539;i din serializare.</span></p><p class="c1"><span class="c3"></span></p><p class="c8"><span class="c6">- </span><span class="c0">JsonPropertyName</span><span class="c3">: permite &icirc;nlocuirea denumirii originale a unei propriet&#259;&#539;i.</span></p><p class="c1"><span class="c3"></span></p><p class="c8"><span class="c3">Exemplu de utilizare:</span></p><p class="c1"><span class="c3"></span></p><a id="t.87267bbc3bcb9786dd6e7a82a43d6ada7d0bb7c4"></a><a id="t.5"></a><table class="c11"><tr class="c17"><td class="c16" colspan="1" rowspan="1"><p class="c12"><span class="c5">using</span><span class="c2">&nbsp;System.Text.Json;<br></span><span class="c5">using</span><span class="c2">&nbsp;System.Text.Json.Serialization;<br><br>Person tom = </span><span class="c5">new</span><span class="c2">&nbsp;Person(</span><span class="c4">&quot;Tom&quot;</span><span class="c2">, </span><span class="c9">37</span><span class="c2">);<br><br></span><span class="c5">string</span><span class="c2">&nbsp;json = JsonSerializer.Serialize&lt;Person&gt;(tom);<br>Console.WriteLine(json);<br>Person? person = JsonSerializer.Deserialize&lt;Person&gt;(json);<br>Console.WriteLine(</span><span class="c4">$&quot;Nume: {person?.Name} &nbsp;V&acirc;rst&#259;: {person?.Age}&quot;</span><span class="c2">);<br><br></span><span class="c5">class</span><span class="c2">&nbsp;</span><span class="c15">Person</span><span class="c2"><br>{<br> &nbsp; &nbsp;[</span><span class="c13">JsonPropertyName(&quot;firstname&quot;)</span><span class="c2">]<br> &nbsp; &nbsp;</span><span class="c5">public</span><span class="c2">&nbsp;</span><span class="c5">string</span><span class="c2">&nbsp;Name { </span><span class="c5">get</span><span class="c2">; }<br> &nbsp; &nbsp;[</span><span class="c13">JsonIgnore</span><span class="c2">]<br> &nbsp; &nbsp;</span><span class="c5">public</span><span class="c2">&nbsp;</span><span class="c5">int</span><span class="c2">&nbsp;Age { </span><span class="c5">get</span><span class="c2">; </span><span class="c5">set</span><span class="c2">; }<br> &nbsp; &nbsp;</span><span class="c5">public</span><span class="c2">&nbsp;</span><span class="c15">Person</span><span class="c2">(</span><span class="c5">string</span><span class="c2">&nbsp;name, </span><span class="c5">int</span><span class="c2">&nbsp;age)<br> &nbsp; &nbsp;{<br> &nbsp; &nbsp; &nbsp; &nbsp;Name = name;<br> &nbsp; &nbsp; &nbsp; &nbsp;Age = age;<br> &nbsp; &nbsp;}<br>}</span></p></td></tr></table><p class="c1"><span class="c3"></span></p><p class="c8"><span class="c3">&Icirc;n acest exemplu, proprietatea Age va fi ignorat&#259;, iar pentru proprietatea Name va fi utilizat pseudonimul &quot;firstname&quot;. Ie&#537;irea &icirc;n consol&#259;:</span></p><p class="c1"><span class="c3"></span></p><a id="t.cbae5a92d58b36471f63881a9ac76bf1e0511b8a"></a><a id="t.6"></a><table class="c11"><tr class="c17"><td class="c16" colspan="1" rowspan="1"><p class="c12"><span class="c2">{</span><span class="c4">&quot;firstname&quot;</span><span class="c2">:</span><span class="c4">&quot;Tom&quot;</span><span class="c2">}<br>Nume: Tom &nbsp; V&acirc;rst&#259;: </span><span class="c9">0</span></p></td></tr></table><p class="c1"><span class="c3"></span></p><p class="c8"><span class="c3">Observa&#539;i c&#259;, deoarece proprietatea Age nu a fost serializat&#259;, la deserializare se utilizeaz&#259; valoarea implicit&#259; pentru aceasta.</span></p><p class="c1"><span class="c3"></span></p></body></html>