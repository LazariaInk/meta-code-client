<html>

<head>
    <meta content="text/html; charset=UTF-8" http-equiv="content-type">
    <link rel="stylesheet" type="text/css" href="/lessons/styles.css">
</head>

<body class="c18 doc-content">
    <h1 class="c11 c19">Condiții în blocări.</h1>
    <p class="c6"><span class="c2"></span></p>
    <p class="c11"><span class="c7">Utilizarea condi&#539;iilor &icirc;n bloc&#259;ri permite controlul asupra
            gestion&#259;rii accesului la fire de execu&#539;ie. O condi&#539;ie de blocare reprezint&#259; un obiect al
            interfe&#539;ei </span><span class="c17">Condition </span><span class="c7">din pachetul </span><span
            class="c1">java.util.concurrent.locks</span><span class="c2">.</span></p>
    <p class="c6"><span class="c2"></span></p>
    <p class="c11"><span class="c7">Utilizarea obiectelor Condition este similar&#259; cu folosirea metodelor
        </span><span class="c1">wait/notify/notifyAll</span><span class="c2">&nbsp;din clasa Object, discutate anterior.
            &Icirc;n particular, putem folosi urm&#259;toarele metode ale interfe&#539;ei Condition:</span></p>
    <p class="c6"><span class="c2"></span></p>
    <ul class="c14 lst-kix_wbf5ygsetmlq-0 start">
        <li class="c9 li-bullet-0"><span class="c17">await</span><span class="c7">: firul de execu&#539;ie
                a&#537;teapt&#259; p&acirc;n&#259; c&acirc;nd se &icirc;ndepline&#537;te o anumit&#259; condi&#539;ie
                &#537;i p&acirc;n&#259; c&acirc;nd alt fir de execu&#539;ie apeleaz&#259; metodele</span><span
                class="c1">&nbsp;signal/signalAll</span><span class="c7">. Este similar&#259; cu metoda </span><span
                class="c1">wait </span><span class="c2">din clasa Object &nbsp;</span></li>
    </ul>
    <p class="c6"><span class="c2"></span></p>
    <ul class="c14 lst-kix_wbf5ygsetmlq-0">
        <li class="c9 li-bullet-0"><span class="c17">signal</span><span class="c7">: semnalizeaz&#259; c&#259; firul de
                execu&#539;ie care a apelat anterior metoda </span><span class="c1">await() </span><span
                class="c7">poate continua lucrul. Utilizarea este similar&#259; cu metoda </span><span class="c1">notify
            </span><span class="c2">din clasa Object &nbsp;</span></li>
    </ul>
    <p class="c6"><span class="c2"></span></p>
    <ul class="c14 lst-kix_wbf5ygsetmlq-0">
        <li class="c9 li-bullet-0"><span class="c17">signalAll</span><span class="c7">: semnalizeaz&#259; tuturor
                firelor care au apelat metoda </span><span class="c1">await() </span><span class="c7">c&#259; pot
                continua lucrul. Este similar&#259; cu metoda </span><span class="c1">notifyAll()</span><span
                class="c2">&nbsp;din clasa Object &nbsp;</span></li>
    </ul>
    <p class="c6"><span class="c2"></span></p>
    <p class="c11"><span class="c2">Aceste metode sunt apelate &icirc;n blocul de cod care intr&#259; sub ac&#539;iunea
            bloc&#259;rii ReentrantLock. Mai &icirc;nt&acirc;i, folosind aceast&#259; blocare, trebuie s&#259;
            ob&#539;inem obiectul Condition:</span></p>
    <p class="c6"><span class="c2"></span></p>
    <table class="c13">
        <tr class="c16">
            <td class="c5" colspan="1" rowspan="1">
                <p class="c15"><span class="c0">ReentrantLock locker = </span><span class="c3">new</span><span
                        class="c0">&nbsp;ReentrantLock();<br>Condition condition = locker.newCondition();</span></p>
            </td>
        </tr>
    </table>
    <p class="c6"><span class="c2"></span></p>
    <p class="c11"><span class="c2">De obicei, se verific&#259; &icirc;nt&acirc;i condi&#539;ia de acces. Dac&#259; se
            respect&#259; condi&#539;ia, firul de execu&#539;ie a&#537;teapt&#259; p&acirc;n&#259; c&acirc;nd aceasta se
            schimb&#259;:</span></p>
    <p class="c6"><span class="c2"></span></p>
    <table class="c13">
        <tr class="c16">
            <td class="c5" colspan="1" rowspan="1">
                <p class="c15"><span class="c3">while</span><span class="c0">&nbsp;(condi&#539;ie)<br> &nbsp;
                        &nbsp;condition.await();</span></p>
            </td>
        </tr>
    </table>
    <p class="c6"><span class="c2"></span></p>
    <p class="c11"><span class="c2">Dup&#259; finalizarea tuturor ac&#539;iunilor, celorlalte fire li se
            semnalizeaz&#259; schimbarea condi&#539;iei:</span></p>
    <p class="c6"><span class="c2"></span></p>
    <table class="c13">
        <tr class="c16">
            <td class="c5" colspan="1" rowspan="1">
                <p class="c15"><span class="c0">condition.signalAll();</span></p>
            </td>
        </tr>
    </table>
    <p class="c6"><span class="c2"></span></p>
    <p class="c11"><span class="c2">Este important s&#259; apel&#259;m metoda signal/signalAll la final, pentru a evita
            posibilitatea bloc&#259;rii reciproce a firelor de execu&#539;ie.</span></p>
    <p class="c6"><span class="c2"></span></p>
    <p class="c11"><span class="c7">Pentru exemplu, vom modifica sarcina din tema despre metodele</span><span
            class="c1">&nbsp;wait/notify</span><span class="c2">, utiliz&acirc;nd obiectul Condition.</span></p>
    <p class="c6"><span class="c2"></span></p>
    <p class="c11"><span class="c2">Avem un depozit &icirc;n care pot fi plasate simultan maximum 3 produse.
            Produc&#259;torul trebuie s&#259; produc&#259; 5 produse, iar cump&#259;r&#259;torul trebuie s&#259; le
            achizi&#539;ioneze. Totodat&#259;, cump&#259;r&#259;torul nu poate cump&#259;ra un produs dac&#259; nu
            exist&#259; produse &icirc;n depozit:</span></p>
    <p class="c6"><span class="c2"></span></p>
    <table class="c13">
        <tr class="c16">
            <td class="c5" colspan="1" rowspan="1">
                <p class="c15"><span class="c3">import</span><span
                        class="c0">&nbsp;java.util.concurrent.locks.ReentrantLock;<br></span><span
                        class="c3">import</span><span class="c0">&nbsp;java.util.concurrent.locks.Condition;<br>
                        <br></span><span class="c3">public</span><span class="c0">&nbsp;</span><span
                        class="c3">class</span><span class="c0">&nbsp;</span><span class="c10">Program</span><span
                        class="c0">&nbsp;{<br> &nbsp;<br> &nbsp; &nbsp;</span><span class="c3">public</span><span
                        class="c0">&nbsp;</span><span class="c3">static</span><span class="c0">&nbsp;</span><span
                        class="c3">void</span><span class="c0">&nbsp;</span><span class="c10">main</span><span
                        class="c0">(String[] args) {<br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br> &nbsp; &nbsp; &nbsp;
                        &nbsp;Store store = </span><span class="c3">new</span><span class="c0">&nbsp;Store();<br> &nbsp;
                        &nbsp; &nbsp; &nbsp;Producer producer = </span><span class="c3">new</span><span
                        class="c0">&nbsp;Producer(store);<br> &nbsp; &nbsp; &nbsp; &nbsp;Consumer consumer =
                    </span><span class="c3">new</span><span class="c0">&nbsp;Consumer(store);<br> &nbsp; &nbsp; &nbsp;
                        &nbsp;</span><span class="c3">new</span><span class="c0">&nbsp;Thread(producer).start();<br>
                        &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c3">new</span><span
                        class="c0">&nbsp;Thread(consumer).start();<br> &nbsp; &nbsp;}<br>}<br><br></span><span
                        class="c8">// Clasa Magazin, care stocheaz&#259; produsele produse</span><span
                        class="c0"><br></span><span class="c3">class</span><span class="c0">&nbsp;</span><span
                        class="c10">Store</span><span class="c0">&nbsp;{<br> &nbsp; </span><span
                        class="c3">private</span><span class="c0">&nbsp;</span><span class="c3">int</span><span
                        class="c0">&nbsp;product = </span><span class="c4">0</span><span class="c0">;<br> &nbsp;
                        ReentrantLock locker;<br> &nbsp; Condition condition;<br> &nbsp; &nbsp;<br> &nbsp; Store() {<br>
                        &nbsp; &nbsp; &nbsp; locker = </span><span class="c3">new</span><span
                        class="c0">&nbsp;ReentrantLock(); </span><span class="c8">// cre&#259;m blocarea</span><span
                        class="c0"><br> &nbsp; &nbsp; &nbsp; condition = locker.newCondition(); </span><span
                        class="c8">// ob&#539;inem condi&#539;ia asociat&#259; cu blocarea</span><span class="c0"><br>
                        &nbsp; }<br> &nbsp; &nbsp;<br> &nbsp; </span><span class="c3">public</span><span
                        class="c0">&nbsp;</span><span class="c3">void</span><span class="c0">&nbsp;</span><span
                        class="c10">get</span><span class="c0">() {<br> &nbsp; &nbsp; &nbsp;locker.lock();<br> &nbsp;
                        &nbsp; &nbsp;</span><span class="c3">try</span><span class="c0">&nbsp;{<br> &nbsp; &nbsp; &nbsp;
                        &nbsp; &nbsp;</span><span class="c8">// c&acirc;t timp nu sunt produse disponibile,
                        a&#537;tept&#259;m</span><span class="c0"><br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span
                        class="c3">while</span><span class="c0">&nbsp;(product &lt; </span><span
                        class="c4">1</span><span class="c0">)<br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
                        &nbsp;condition.await();<br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br> &nbsp; &nbsp; &nbsp; &nbsp;
                        &nbsp;product--;<br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;System.out.println(</span><span
                        class="c12">&quot;Cump&#259;r&#259;torul a cump&#259;rat 1 produs&quot;</span><span
                        class="c0">);<br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;System.out.println(</span><span
                        class="c12">&quot;Produse &icirc;n depozit: &quot;</span><span class="c0">&nbsp;+ product);<br>
                        &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span
                        class="c8">// semnaliz&#259;m</span><span class="c0"><br> &nbsp; &nbsp; &nbsp; &nbsp;
                        &nbsp;condition.signalAll();<br> &nbsp; &nbsp; &nbsp;}<br> &nbsp; &nbsp; &nbsp;</span><span
                        class="c3">catch</span><span class="c0">&nbsp;(InterruptedException e) {<br> &nbsp; &nbsp;
                        &nbsp; &nbsp; &nbsp;System.out.println(e.getMessage());<br> &nbsp; &nbsp; &nbsp;}<br> &nbsp;
                        &nbsp; &nbsp;</span><span class="c3">finally</span><span class="c0">&nbsp;{<br> &nbsp; &nbsp;
                        &nbsp; &nbsp; &nbsp;locker.unlock();<br> &nbsp; &nbsp; &nbsp;}<br> &nbsp; }<br><br> &nbsp;
                    </span><span class="c3">public</span><span class="c0">&nbsp;</span><span class="c3">void</span><span
                        class="c0">&nbsp;</span><span class="c10">put</span><span class="c0">() {<br> &nbsp; &nbsp;
                        &nbsp; locker.lock();<br> &nbsp; &nbsp; &nbsp; </span><span class="c3">try</span><span
                        class="c0">&nbsp;{<br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c8">// c&acirc;t
                        timp sunt 3 produse &icirc;n depozit, a&#537;tept&#259;m eliberarea spa&#539;iului</span><span
                        class="c0"><br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c3">while</span><span
                        class="c0">&nbsp;(product &gt;= </span><span class="c4">3</span><span class="c0">)<br> &nbsp;
                        &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;condition.await();<br> &nbsp; &nbsp; &nbsp; &nbsp;
                        &nbsp; <br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;product++;<br> &nbsp; &nbsp; &nbsp; &nbsp;
                        &nbsp;System.out.println(</span><span class="c12">&quot;Produc&#259;torul a ad&#259;ugat 1
                        produs&quot;</span><span class="c0">);<br> &nbsp; &nbsp; &nbsp; &nbsp;
                        &nbsp;System.out.println(</span><span class="c12">&quot;Produse &icirc;n depozit:
                        &quot;</span><span class="c0">&nbsp;+ product);<br> &nbsp; &nbsp; &nbsp; &nbsp;
                        &nbsp;</span><span class="c8">// semnaliz&#259;m</span><span class="c0"><br> &nbsp; &nbsp;
                        &nbsp; &nbsp; &nbsp;condition.signalAll();<br> &nbsp; &nbsp; &nbsp;}<br> &nbsp; &nbsp;
                        &nbsp;</span><span class="c3">catch</span><span class="c0">&nbsp;(InterruptedException e) {<br>
                        &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;System.out.println(e.getMessage());<br> &nbsp; &nbsp;
                        &nbsp;}<br> &nbsp; &nbsp; &nbsp;</span><span class="c3">finally</span><span
                        class="c0">&nbsp;{<br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;locker.unlock();<br> &nbsp; &nbsp;
                        &nbsp;}<br> &nbsp; }<br>}<br><br></span><span class="c8">// Clasa Produc&#259;tor</span><span
                        class="c0"><br></span><span class="c3">class</span><span class="c0">&nbsp;</span><span
                        class="c10">Producer</span><span class="c0">&nbsp;</span><span class="c3">implements</span><span
                        class="c0">&nbsp;</span><span class="c10">Runnable</span><span class="c0">&nbsp;{<br> &nbsp;<br>
                        &nbsp; &nbsp;Store store;<br> &nbsp; &nbsp;Producer(Store store) {<br> &nbsp; &nbsp; &nbsp;
                    </span><span class="c3">this</span><span class="c0">.store = store; <br> &nbsp; &nbsp;}<br> &nbsp;
                        &nbsp;</span><span class="c3">public</span><span class="c0">&nbsp;</span><span
                        class="c3">void</span><span class="c0">&nbsp;</span><span class="c10">run</span><span
                        class="c0">() {<br> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c3">for</span><span
                        class="c0">&nbsp;(</span><span class="c3">int</span><span class="c0">&nbsp;i = </span><span
                        class="c4">1</span><span class="c0">; i &lt; </span><span class="c4">6</span><span class="c0">;
                        i++) {<br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;store.put();<br> &nbsp; &nbsp; &nbsp;
                        &nbsp;}<br> &nbsp; &nbsp;}<br>}<br><br></span><span class="c8">// Clasa Consumator</span><span
                        class="c0"><br></span><span class="c3">class</span><span class="c0">&nbsp;</span><span
                        class="c10">Consumer</span><span class="c0">&nbsp;</span><span class="c3">implements</span><span
                        class="c0">&nbsp;</span><span class="c10">Runnable</span><span class="c0">&nbsp;{<br> &nbsp;
                        &nbsp; &nbsp;<br> &nbsp; &nbsp;Store store;<br> &nbsp; &nbsp;Consumer(Store store) {<br> &nbsp;
                        &nbsp; &nbsp; </span><span class="c3">this</span><span class="c0">.store = store; <br> &nbsp;
                        &nbsp;}<br> &nbsp; &nbsp;</span><span class="c3">public</span><span
                        class="c0">&nbsp;</span><span class="c3">void</span><span class="c0">&nbsp;</span><span
                        class="c10">run</span><span class="c0">() {<br> &nbsp; &nbsp; &nbsp; &nbsp;</span><span
                        class="c3">for</span><span class="c0">&nbsp;(</span><span class="c3">int</span><span
                        class="c0">&nbsp;i = </span><span class="c4">1</span><span class="c0">; i &lt; </span><span
                        class="c4">6</span><span class="c0">; i++) {<br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
                        &nbsp;store.get();<br> &nbsp; &nbsp; &nbsp; &nbsp;}<br> &nbsp; &nbsp;}<br>}</span></p>
            </td>
        </tr>
    </table>
    <p class="c6"><span class="c2"></span></p>
    <p class="c11"><span class="c2">&Icirc;n final, vom ob&#539;ine o ie&#537;ire asem&#259;n&#259;toare cu
            aceasta:</span></p>
    <p class="c6"><span class="c2"></span></p>
    <table class="c13">
        <tr class="c16">
            <td class="c5" colspan="1" rowspan="1">
                <p class="c15"><span class="c0">Produc&#259;torul a ad&#259;ugat </span><span class="c4">1</span><span
                        class="c0">&nbsp;produs<br>Produse &icirc;n depozit: </span><span class="c4">1</span><span
                        class="c0"><br>Produc&#259;torul a ad&#259;ugat </span><span class="c4">1</span><span
                        class="c0">&nbsp;produs<br>Produse &icirc;n depozit: </span><span class="c4">2</span><span
                        class="c0"><br>Produc&#259;torul a ad&#259;ugat </span><span class="c4">1</span><span
                        class="c0">&nbsp;produs<br>Produse &icirc;n depozit: </span><span class="c4">3</span><span
                        class="c0"><br>Cump&#259;r&#259;torul a cump&#259;rat </span><span class="c4">1</span><span
                        class="c0">&nbsp;produs<br>Produse &icirc;n depozit: </span><span class="c4">2</span><span
                        class="c0"><br>Cump&#259;r&#259;torul a cump&#259;rat </span><span class="c4">1</span><span
                        class="c0">&nbsp;produs<br>Produse &icirc;n depozit: </span><span class="c4">1</span><span
                        class="c0"><br>Cump&#259;r&#259;torul a cump&#259;rat </span><span class="c4">1</span><span
                        class="c0">&nbsp;produs<br>Produse &icirc;n depozit: </span><span class="c4">0</span><span
                        class="c0"><br>Produc&#259;torul a ad&#259;ugat </span><span class="c4">1</span><span
                        class="c0">&nbsp;produs<br>Produse &icirc;n depozit: </span><span class="c4">1</span><span
                        class="c0"><br>Produc&#259;torul a ad&#259;ugat </span><span class="c4">1</span><span
                        class="c0">&nbsp;produs<br>Produse &icirc;n depozit: </span><span class="c4">2</span><span
                        class="c0"><br>Cump&#259;r&#259;torul a cump&#259;rat </span><span class="c4">1</span><span
                        class="c0">&nbsp;produs<br>Produse &icirc;n depozit: </span><span class="c4">1</span><span
                        class="c0"><br>Cump&#259;r&#259;torul a cump&#259;rat </span><span class="c4">1</span><span
                        class="c0">&nbsp;produs<br>Produse &icirc;n depozit: </span><span class="c4">0</span></p>
            </td>
        </tr>
    </table>
    <p class="c6"><span class="c2"></span></p>
    <p class="c6"><span class="c2"></span></p>
</body>

</html>