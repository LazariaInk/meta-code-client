<html>

<head>
    <meta content="text/html; charset=UTF-8" http-equiv="content-type">
    <link rel="stylesheet" type="text/css" href="/lessons/styles.css">
</head>

<body class="c17 doc-content">
    <h1 class="c14 c6">Clasa Phaser.</h1>
    <p class="c8"><span class="c0"></span></p>
    <p class="c14"><span class="c11">Clasa </span><span class="c4">Phaser </span><span class="c0">permite sincronizarea
            thread-urilor care reprezint&#259; faze sau etape distincte ale unei ac&#539;iuni comune. Phaser
            define&#537;te un obiect de sincronizare care a&#537;teapt&#259; finalizarea unei anumite faze de c&#259;tre
            toate thread-urile participante. Dup&#259; aceea, Phaser trece la faza urm&#259;toare &#537;i
            a&#537;teapt&#259; din nou finalizarea acesteia.</span></p>
    <p class="c8"><span class="c0"></span></p>
    <p class="c14"><span class="c0">Pentru a crea un obiect Phaser, putem folosi unul dintre urm&#259;toarele
            constructoare:</span></p>
    <p class="c8"><span class="c0"></span></p>
    <table class="c12">
        <tr class="c5">
            <td class="c13" colspan="1" rowspan="1">
                <p class="c16"><span class="c3">Phaser()<br>Phaser(</span><span class="c7">int</span><span
                        class="c3">&nbsp;parties)<br>Phaser(Phaser parent)<br>Phaser(Phaser parent, </span><span
                        class="c7">int</span><span class="c3">&nbsp;parties)</span></p>
            </td>
        </tr>
    </table>
    <p class="c8"><span class="c0"></span></p>
    <p class="c14"><span class="c11">Parametrul </span><span class="c11 c15">parties </span><span
            class="c0">specific&#259; num&#259;rul de participan&#539;i (&icirc;n esen&#539;&#259;, thread-uri) care vor
            executa toate fazele ac&#539;iunii. Primul constructor creeaz&#259; un obiect Phaser f&#259;r&#259;
            participan&#539;i. Al doilea constructor &icirc;nregistreaz&#259; num&#259;rul de participan&#539;i transmis
            ca parametru. Al treilea &#537;i al patrulea constructor stabilesc &#537;i un obiect Phaser
            p&#259;rinte.</span></p>
    <p class="c8"><span class="c0"></span></p>
    <p class="c14"><span class="c0">Metodele principale ale clasei Phaser:</span></p>
    <p class="c8"><span class="c0"></span></p>
    <p class="c14"><span class="c11">- </span><span class="c4">int register()</span><span class="c0">:
            &icirc;nregistreaz&#259; un participant care execut&#259; fazele &#537;i returneaz&#259; num&#259;rul fazei
            curente (&icirc;n mod normal, faza 0).</span></p>
    <p class="c8"><span class="c0"></span></p>
    <p class="c14"><span class="c11">- </span><span class="c4">int arrive()</span><span class="c0">: informeaz&#259;
            c&#259; participantul a terminat faza &#537;i returneaz&#259; num&#259;rul fazei curente.</span></p>
    <p class="c8"><span class="c0"></span></p>
    <p class="c14"><span class="c11">-</span><span class="c4">&nbsp;int arriveAndAwaitAdvance()</span><span
            class="c11">: similar metodei </span><span class="c11 c15">arrive()</span><span class="c0">, dar
            a&#537;teapt&#259; ca to&#539;i participan&#539;ii s&#259; termine faza curent&#259; &icirc;nainte de a
            continua.</span></p>
    <p class="c8"><span class="c0"></span></p>
    <p class="c14"><span class="c11">- </span><span class="c4">int arriveAndDeregister()</span><span class="c0">:
            informeaz&#259; c&#259; participantul a terminat toate fazele &#537;i se deregistreaz&#259;. Returneaz&#259;
            num&#259;rul fazei curente sau un num&#259;r negativ dac&#259; Phaser &#537;i-a &icirc;ncheiat
            activitatea.</span></p>
    <p class="c8"><span class="c0"></span></p>
    <p class="c14"><span class="c11">- </span><span class="c4">int getPhase()</span><span class="c0">: returneaz&#259;
            num&#259;rul fazei curente.</span></p>
    <p class="c8"><span class="c0"></span></p>
    <p class="c14"><span class="c0">Exemplu de utilizare a clasei Phaser:</span></p>
    <p class="c8"><span class="c0"></span></p>
    <p class="c14"><span class="c0">Mai jos este un exemplu de sincronizare a mai multor thread-uri care trec prin mai
            multe faze:</span></p>
    <p class="c8"><span class="c0"></span></p>
    <table class="c12">
        <tr class="c5">
            <td class="c13" colspan="1" rowspan="1">
                <p class="c16"><span class="c7">import</span><span
                        class="c3">&nbsp;java.util.concurrent.Phaser;<br><br></span><span class="c7">public</span><span
                        class="c3">&nbsp;</span><span class="c7">class</span><span class="c3">&nbsp;</span><span
                        class="c2">Program</span><span class="c3">&nbsp;{<br><br> &nbsp; &nbsp;</span><span
                        class="c7">public</span><span class="c3">&nbsp;</span><span class="c7">static</span><span
                        class="c3">&nbsp;</span><span class="c7">void</span><span class="c3">&nbsp;</span><span
                        class="c2">main</span><span class="c3">(String[] args) {<br> &nbsp; &nbsp; &nbsp; &nbsp;<br>
                        &nbsp; &nbsp; &nbsp; &nbsp;Phaser phaser = </span><span class="c7">new</span><span
                        class="c3">&nbsp;Phaser(</span><span class="c10">1</span><span class="c3">); </span><span
                        class="c9">// &Icirc;nregistr&#259;m thread-ul principal</span><span class="c3"><br> &nbsp;
                        &nbsp; &nbsp; &nbsp;</span><span class="c7">new</span><span class="c3">&nbsp;Thread(</span><span
                        class="c7">new</span><span class="c3">&nbsp;PhaseThread(phaser, </span><span
                        class="c1">&quot;PhaseThread 1&quot;</span><span class="c3">)).start();<br> &nbsp; &nbsp; &nbsp;
                        &nbsp;</span><span class="c7">new</span><span class="c3">&nbsp;Thread(</span><span
                        class="c7">new</span><span class="c3">&nbsp;PhaseThread(phaser, </span><span
                        class="c1">&quot;PhaseThread 2&quot;</span><span class="c3">)).start();<br> &nbsp; &nbsp; &nbsp;
                        &nbsp;<br> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c9">// A&#537;tept&#259;m finalizarea
                        fazei 0</span><span class="c3"><br> &nbsp; &nbsp; &nbsp; &nbsp;</span><span
                        class="c7">int</span><span class="c3">&nbsp;phase = phaser.getPhase();<br> &nbsp; &nbsp; &nbsp;
                        &nbsp;phaser.arriveAndAwaitAdvance();<br> &nbsp; &nbsp; &nbsp;
                        &nbsp;System.out.println(</span><span class="c1">&quot;Faza &quot;</span><span
                        class="c3">&nbsp;+ phase + </span><span class="c1">&quot; s-a &icirc;ncheiat&quot;</span><span
                        class="c3">);<br> &nbsp; &nbsp; &nbsp; &nbsp;<br> &nbsp; &nbsp; &nbsp; &nbsp;</span><span
                        class="c9">// A&#537;tept&#259;m finalizarea fazei 1</span><span class="c3"><br> &nbsp; &nbsp;
                        &nbsp; &nbsp;phase = phaser.getPhase();<br> &nbsp; &nbsp; &nbsp;
                        &nbsp;phaser.arriveAndAwaitAdvance();<br> &nbsp; &nbsp; &nbsp;
                        &nbsp;System.out.println(</span><span class="c1">&quot;Faza &quot;</span><span
                        class="c3">&nbsp;+ phase + </span><span class="c1">&quot; s-a &icirc;ncheiat&quot;</span><span
                        class="c3">);<br> &nbsp; &nbsp; &nbsp; &nbsp;<br> &nbsp; &nbsp; &nbsp; &nbsp;</span><span
                        class="c9">// A&#537;tept&#259;m finalizarea fazei 2</span><span class="c3"><br> &nbsp; &nbsp;
                        &nbsp; &nbsp;phase = phaser.getPhase();<br> &nbsp; &nbsp; &nbsp;
                        &nbsp;phaser.arriveAndAwaitAdvance();<br> &nbsp; &nbsp; &nbsp;
                        &nbsp;System.out.println(</span><span class="c1">&quot;Faza &quot;</span><span
                        class="c3">&nbsp;+ phase + </span><span class="c1">&quot; s-a &icirc;ncheiat&quot;</span><span
                        class="c3">);<br> &nbsp; &nbsp; &nbsp; &nbsp;<br> &nbsp; &nbsp; &nbsp;
                        &nbsp;phaser.arriveAndDeregister(); </span><span class="c9">// Deregistr&#259;m thread-ul
                        principal</span><span class="c3"><br> &nbsp; &nbsp;}<br>}<br><br></span><span
                        class="c7">class</span><span class="c3">&nbsp;</span><span class="c2">PhaseThread</span><span
                        class="c3">&nbsp;</span><span class="c7">implements</span><span class="c3">&nbsp;</span><span
                        class="c2">Runnable</span><span class="c3">&nbsp;{<br> &nbsp; &nbsp;<br> &nbsp; &nbsp;Phaser
                        phaser;<br> &nbsp; &nbsp;String name;<br><br> &nbsp; &nbsp;PhaseThread(Phaser p, String n) {<br>
                        &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c7">this</span><span class="c3">.phaser = p;<br>
                        &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c7">this</span><span class="c3">.name = n;<br>
                        &nbsp; &nbsp; &nbsp; &nbsp;phaser.register(); </span><span class="c9">// &Icirc;nregistr&#259;m
                        thread-ul</span><span class="c3"><br> &nbsp; &nbsp;}<br><br> &nbsp; &nbsp;</span><span
                        class="c7">public</span><span class="c3">&nbsp;</span><span class="c7">void</span><span
                        class="c3">&nbsp;</span><span class="c2">run</span><span class="c3">() {<br> &nbsp; &nbsp;
                        &nbsp; &nbsp;System.out.println(name + </span><span class="c1">&quot; execut&#259; faza
                        &quot;</span><span class="c3">&nbsp;+ phaser.getPhase());<br> &nbsp; &nbsp; &nbsp;
                        &nbsp;phaser.arriveAndAwaitAdvance(); </span><span class="c9">// Finaliz&#259;m prima
                        faz&#259;</span><span class="c3"><br><br> &nbsp; &nbsp; &nbsp; &nbsp;System.out.println(name +
                    </span><span class="c1">&quot; execut&#259; faza &quot;</span><span class="c3">&nbsp;+
                        phaser.getPhase());<br> &nbsp; &nbsp; &nbsp; &nbsp;phaser.arriveAndAwaitAdvance(); </span><span
                        class="c9">// Finaliz&#259;m a doua faz&#259;</span><span class="c3"><br><br> &nbsp; &nbsp;
                        &nbsp; &nbsp;System.out.println(name + </span><span class="c1">&quot; execut&#259; faza
                        &quot;</span><span class="c3">&nbsp;+ phaser.getPhase());<br> &nbsp; &nbsp; &nbsp;
                        &nbsp;phaser.arriveAndDeregister(); </span><span class="c9">// Finaliz&#259;m toate fazele
                        &#537;i deregistr&#259;m thread-ul</span><span class="c3"><br> &nbsp; &nbsp;}<br>}</span></p>
            </td>
        </tr>
    </table>
    <p class="c8"><span class="c0"></span></p>
    <p class="c14"><span class="c11">&Icirc;n acest exemplu, avem trei participan&#539;i care execut&#259; fazele:
            thread-ul principal &#537;i dou&#259; thread-uri de tip PhaseThread. De aceea, atunci c&acirc;nd se
            creeaz&#259; obiectul Phaser, &icirc;i este transmis num&#259;rul 1, care corespunde thread-ului principal.
            &Icirc;n constructorul clasei PhaseThread, se apeleaz&#259; metoda </span><span
            class="c11 c15">register()</span><span class="c0">&nbsp;pentru a &icirc;nregistra cele dou&#259; thread-uri
            suplimentare.</span></p>
    <p class="c8"><span class="c0"></span></p>
    <p class="c14"><span class="c11">Am fi putut omite apelul metodei </span><span
            class="c11 c15">register()</span><span class="c11">&nbsp;&#537;i, &icirc;n schimb, am fi putut
            ini&#539;ializa Phaser cu 3 participan&#539;i direct, adic&#259; folosind </span><span
            class="c11 c15">Phaser phaser = new Phaser(3)</span><span class="c0">, deoarece avem trei participan&#539;i
            &icirc;n total.</span></p>
    <p class="c8"><span class="c0"></span></p>
    <p class="c14"><span class="c11">Fiecare faz&#259; pentru un participant reprezint&#259; un set minimal de
            ac&#539;iuni. &Icirc;n cazul thread-urilor PhaseThread, acestea constau doar &icirc;n afi&#537;area unui
            mesaj, iar pentru thread-ul principal, ac&#539;iunea implic&#259; num&#259;rarea fazei curente folosind
            metoda </span><span class="c11 c15">getPhase()</span><span class="c0">. Numerotarea fazelor &icirc;ncepe de
            la zero.</span></p>
    <p class="c8"><span class="c0"></span></p>
    <p class="c14"><span class="c11">Fiecare participant finalizeaz&#259; execu&#539;ia unei faze apel&acirc;nd metoda
        </span><span class="c11 c15">phaser.arriveAndAwaitAdvance()</span><span class="c0">. Aceast&#259; metod&#259;
            blocheaz&#259; thread-ul p&acirc;n&#259; c&acirc;nd to&#539;i participan&#539;ii finalizeaz&#259; faza
            curent&#259;. Astfel, dac&#259; un thread ajunge la finalul fazei &#537;i apeleaz&#259; aceast&#259;
            metod&#259;, va trebui s&#259; a&#537;tepte ca &#537;i celelalte thread-uri s&#259; finalizeze &icirc;nainte
            de a putea continua cu urm&#259;toarea faz&#259;.</span></p>
    <p class="c8"><span class="c0"></span></p>
    <p class="c14"><span class="c11">Dup&#259; ce toate fazele au fost finalizate, thread-urile se deregistreaz&#259;
            folosind metoda</span><span class="c11 c15">&nbsp;arriveAndDeregister()</span><span class="c0">. Aceasta
            semnaleaz&#259; c&#259; thread-ul &#537;i-a terminat participarea &icirc;n toate fazele &#537;i nu mai
            trebuie sincronizat &icirc;n continuare.</span></p>
    <p class="c8"><span class="c0"></span></p>
    <p class="c14"><span class="c0">&Icirc;n final, rularea programului va oferi urm&#259;torul rezultat:</span></p>
    <p class="c8"><span class="c0"></span></p>
    <table class="c12">
        <tr class="c5">
            <td class="c13" colspan="1" rowspan="1">
                <p class="c16"><span class="c3">PhaseThread </span><span class="c10">1</span><span
                        class="c3">&nbsp;execut&#259; faza </span><span class="c10">0</span><span
                        class="c3"><br>PhaseThread </span><span class="c10">2</span><span class="c3">&nbsp;execut&#259;
                        faza </span><span class="c10">0</span><span class="c3"><br>PhaseThread </span><span
                        class="c10">1</span><span class="c3">&nbsp;execut&#259; faza </span><span
                        class="c10">1</span><span class="c3"><br>PhaseThread </span><span class="c10">2</span><span
                        class="c3">&nbsp;execut&#259; faza </span><span class="c10">1</span><span class="c3"><br>Faza
                    </span><span class="c10">0</span><span class="c3">&nbsp;a fost finalizat&#259;<br>Faza </span><span
                        class="c10">1</span><span class="c3">&nbsp;a fost finalizat&#259;<br>PhaseThread </span><span
                        class="c10">1</span><span class="c3">&nbsp;execut&#259; faza </span><span
                        class="c10">2</span><span class="c3"><br>PhaseThread </span><span class="c10">2</span><span
                        class="c3">&nbsp;execut&#259; faza </span><span class="c10">2</span><span class="c3"><br>Faza
                    </span><span class="c10">2</span><span class="c3">&nbsp;a fost finalizat&#259;</span></p>
            </td>
        </tr>
    </table>
    <p class="c8"><span class="c0"></span></p>
    <p class="c14"><span class="c0">&Icirc;n acest caz, se ob&#539;ine o ie&#537;ire pu&#539;in confuz&#259;. Astfel,
            mesajele despre execu&#539;ia fazei 1 sunt afi&#537;ate dup&#259; mesajul despre &icirc;ncheierea fazei 0.
            Acest lucru este legat de multi-threading &ndash; fazele s-au &icirc;ncheiat, dar &icirc;ntr-un fir de
            execu&#539;ie &icirc;nc&#259; nu a fost afi&#537;at mesajul despre finalizare, &icirc;n timp ce alte fire au
            &icirc;nceput deja execu&#539;ia fazei urm&#259;toare. Oricum, toate acestea se &icirc;nt&acirc;mpl&#259;
            dup&#259; &icirc;ncheierea fazei.</span></p>
    <p class="c8"><span class="c0"></span></p>
    <p class="c14"><span class="c0">Dar, pentru a fi mai clar, putem folosi sleep &icirc;n firele de
            execu&#539;ie:</span></p>
    <p class="c8"><span class="c0"></span></p>
    <table class="c12">
        <tr class="c5">
            <td class="c13" colspan="1" rowspan="1">
                <p class="c16"><span class="c7">public</span><span class="c3">&nbsp;</span><span
                        class="c7">void</span><span class="c3">&nbsp;</span><span class="c2">run</span><span
                        class="c3">(){<br><br> &nbsp; &nbsp;System.out.println(name + </span><span class="c1">&quot;
                        execut&#259; faza &quot;</span><span class="c3">&nbsp;+ phaser.getPhase());<br> &nbsp;
                        &nbsp;phaser.arriveAndAwaitAdvance(); </span><span class="c9">// raport&#259;m c&#259; prima
                        faz&#259; a fost atins&#259;</span><span class="c3"><br> &nbsp; &nbsp;</span><span
                        class="c7">try</span><span class="c3">{<br> &nbsp; &nbsp; &nbsp; &nbsp;Thread.sleep(</span><span
                        class="c10">200</span><span class="c3">);<br> &nbsp; &nbsp;}<br> &nbsp; &nbsp;</span><span
                        class="c7">catch</span><span class="c3">(InterruptedException ex){<br> &nbsp; &nbsp; &nbsp;
                        &nbsp;System.out.println(ex.getMessage());<br> &nbsp; &nbsp;}<br><br> &nbsp;
                        &nbsp;System.out.println(name + </span><span class="c1">&quot; execut&#259; faza
                        &quot;</span><span class="c3">&nbsp;+ phaser.getPhase());<br> &nbsp;
                        &nbsp;phaser.arriveAndAwaitAdvance(); </span><span class="c9">// raport&#259;m c&#259; a doua
                        faz&#259; a fost atins&#259;</span><span class="c3"><br> &nbsp; &nbsp;</span><span
                        class="c7">try</span><span class="c3">{<br> &nbsp; &nbsp; &nbsp; &nbsp;Thread.sleep(</span><span
                        class="c10">200</span><span class="c3">);<br> &nbsp; &nbsp;}<br> &nbsp; &nbsp;</span><span
                        class="c7">catch</span><span class="c3">(InterruptedException ex){<br> &nbsp; &nbsp; &nbsp;
                        &nbsp;System.out.println(ex.getMessage());<br> &nbsp; &nbsp;}<br> &nbsp;
                        &nbsp;System.out.println(name + </span><span class="c1">&quot; execut&#259; faza
                        &quot;</span><span class="c3">&nbsp;+ phaser.getPhase());<br> &nbsp;
                        &nbsp;phaser.arriveAndDeregister(); </span><span class="c9">// raport&#259;m &icirc;ncheierea
                        fazelor &#537;i deregistr&#259;m obiectele</span><span class="c3"><br>}</span></p>
            </td>
        </tr>
    </table>
    <p class="c8"><span class="c0"></span></p>
    <p class="c14"><span class="c0">&#536;i &icirc;n acest caz ie&#537;irea va fi mai obi&#537;nuit&#259;, de&#537;i nu
            va afecta modul de lucru al fazelor.</span></p>
    <p class="c8"><span class="c0"></span></p>
    <table class="c12">
        <tr class="c5">
            <td class="c13" colspan="1" rowspan="1">
                <p class="c16"><span class="c3">PhaseThread </span><span class="c10">1</span><span
                        class="c3">&nbsp;execut&#259; faza </span><span class="c10">0</span><span
                        class="c3"><br>PhaseThread </span><span class="c10">2</span><span class="c3">&nbsp;execut&#259;
                        faza </span><span class="c10">0</span><span class="c3"><br>Faza </span><span
                        class="c10">0</span><span class="c3">&nbsp;a fost finalizat&#259;<br>PhaseThread </span><span
                        class="c10">2</span><span class="c3">&nbsp;execut&#259; faza </span><span
                        class="c10">1</span><span class="c3"><br>PhaseThread </span><span class="c10">1</span><span
                        class="c3">&nbsp;execut&#259; faza </span><span class="c10">1</span><span class="c3"><br>Faza
                    </span><span class="c10">1</span><span class="c3">&nbsp;a fost finalizat&#259;<br>PhaseThread
                    </span><span class="c10">2</span><span class="c3">&nbsp;execut&#259; faza </span><span
                        class="c10">2</span><span class="c3"><br>PhaseThread </span><span class="c10">1</span><span
                        class="c3">&nbsp;execut&#259; faza </span><span class="c10">2</span><span class="c3"><br>Faza
                    </span><span class="c10">2</span><span class="c3">&nbsp;a fost finalizat&#259;</span></p>
            </td>
        </tr>
    </table>
    <p class="c8"><span class="c0"></span></p>
    <p class="c8"><span class="c0"></span></p>
</body>

</html>