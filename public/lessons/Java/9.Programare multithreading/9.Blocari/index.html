<html>

<head>
    <meta content="text/html; charset=UTF-8" http-equiv="content-type">
    <link rel="stylesheet" type="text/css" href="/lessons/styles.css">
</head>

<body class="c19 doc-content">
    <h1 class="c11 c15">BlocÄƒri. ReentrantLock.</h1>
    <p class="c1"><span class="c2"></span></p>
    <p class="c11"><span class="c14">Pentru gestionarea accesului la o resurs&#259; comun&#259;, ca alternativ&#259; la
            operatorul synchronized, putem folosi bloc&#259;rile. Func&#539;ionalitatea bloc&#259;rilor este
            inclus&#259; &icirc;n pachetul </span><span class="c6">java.util.concurrent.locks</span><span
            class="c2">.</span></p>
    <p class="c1"><span class="c2"></span></p>
    <p class="c11"><span class="c2">La &icirc;nceput, firul de execu&#539;ie &icirc;ncearc&#259; s&#259; acceseze
            resursa comun&#259;. Dac&#259; aceasta este liber&#259;, se aplic&#259; o blocare. Dup&#259; finalizarea
            lucrului, blocarea este eliberat&#259; de pe resurs&#259;. Dac&#259; resursa nu este liber&#259; &#537;i
            deja are o blocare aplicat&#259;, firul de execu&#539;ie a&#537;teapt&#259; p&acirc;n&#259; c&acirc;nd
            blocarea este eliberat&#259;.</span></p>
    <p class="c1"><span class="c2"></span></p>
    <p class="c11"><span class="c2">Clasele de bloc&#259;ri implementeaz&#259; interfa&#539;a Lock, care define&#537;te
            urm&#259;toarele metode:</span></p>
    <p class="c1"><span class="c2"></span></p>
    <ul class="c3 lst-kix_qzbliw2x8np-0 start">
        <li class="c10 li-bullet-0"><span class="c6">void lock()</span><span class="c2">: a&#537;teapt&#259;
                p&acirc;n&#259; c&acirc;nd se ob&#539;ine blocarea &nbsp;</span></li>
    </ul>
    <p class="c1"><span class="c2"></span></p>
    <ul class="c3 lst-kix_qzbliw2x8np-0">
        <li class="c10 li-bullet-0"><span class="c6">void lockInterruptibly() throws InterruptedException</span><span
                class="c2">: a&#537;teapt&#259; p&acirc;n&#259; c&acirc;nd se ob&#539;ine blocarea, dac&#259; firul de
                execu&#539;ie nu este &icirc;ntrerupt &nbsp;</span></li>
    </ul>
    <p class="c1"><span class="c2"></span></p>
    <ul class="c3 lst-kix_qzbliw2x8np-0">
        <li class="c10 li-bullet-0"><span class="c6">boolean tryLock()</span><span class="c14">: &icirc;ncearc&#259;
                s&#259; ob&#539;in&#259; blocarea; dac&#259; se ob&#539;ine, returneaz&#259; true. Dac&#259; nu,
                returneaz&#259; false. Spre deosebire de metoda</span><span class="c9">&nbsp;lock()</span><span
                class="c2">, nu a&#537;teapt&#259; ob&#539;inerea bloc&#259;rii, dac&#259; aceasta nu este
                disponibil&#259; &nbsp;</span></li>
    </ul>
    <p class="c1"><span class="c2"></span></p>
    <ul class="c3 lst-kix_qzbliw2x8np-0">
        <li class="c10 li-bullet-0"><span class="c6">void unlock()</span><span class="c2">: elibereaz&#259; blocarea
                &nbsp;</span></li>
    </ul>
    <p class="c1"><span class="c2"></span></p>
    <ul class="c3 lst-kix_qzbliw2x8np-0">
        <li class="c10 li-bullet-0"><span class="c6">Condition newCondition()</span><span class="c2">: returneaz&#259;
                un obiect Condition, care este asociat cu blocarea curent&#259; &nbsp;</span></li>
    </ul>
    <p class="c1"><span class="c2"></span></p>
    <p class="c11"><span class="c14">Organizarea unei bloc&#259;ri, &icirc;n general, este destul de simpl&#259;: pentru
            a ob&#539;ine blocarea se apeleaz&#259; metoda</span><span class="c9">&nbsp;lock()</span><span class="c14">,
            iar dup&#259; ce lucrul cu resursele comune este &icirc;ncheiat, se apeleaz&#259; metoda</span><span
            class="c9">&nbsp;unlock()</span><span class="c2">, care elibereaz&#259; blocarea.</span></p>
    <p class="c1"><span class="c2"></span></p>
    <p class="c11"><span class="c2">Obiectul Condition permite gestionarea bloc&#259;rii.</span></p>
    <p class="c1"><span class="c2"></span></p>
    <p class="c11"><span class="c14">De obicei, pentru lucrul cu bloc&#259;ri, se folose&#537;te clasa </span><span
            class="c6">ReentrantLock </span><span class="c14">din pachetul </span><span
            class="c9">java.util.concurrent.locks</span><span class="c2">. Aceast&#259; clas&#259; implementeaz&#259;
            interfa&#539;a Lock.</span></p>
    <p class="c1"><span class="c2"></span></p>
    <p class="c11"><span class="c2">Pentru exemplu, vom lua codul din tema despre operatorul synchronized &#537;i vom
            rescrie acest cod folosind blocarea ReentrantLock:</span></p>
    <p class="c1"><span class="c2"></span></p>
    <table class="c16">
        <tr class="c12">
            <td class="c7" colspan="1" rowspan="1">
                <p class="c18"><span class="c5">import</span><span
                        class="c4">&nbsp;java.util.concurrent.locks.ReentrantLock;<br><br></span><span
                        class="c5">public</span><span class="c4">&nbsp;</span><span class="c5">class</span><span
                        class="c4">&nbsp;</span><span class="c8">Program</span><span class="c4">&nbsp;{<br> &nbsp;<br>
                        &nbsp; &nbsp;</span><span class="c5">public</span><span class="c4">&nbsp;</span><span
                        class="c5">static</span><span class="c4">&nbsp;</span><span class="c5">void</span><span
                        class="c4">&nbsp;</span><span class="c8">main</span><span class="c4">(String[] args) {<br>
                        &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br> &nbsp; &nbsp; &nbsp; &nbsp;CommonResource commonResource
                        = </span><span class="c5">new</span><span class="c4">&nbsp;CommonResource();<br> &nbsp; &nbsp;
                        &nbsp; &nbsp;ReentrantLock locker = </span><span class="c5">new</span><span
                        class="c4">&nbsp;ReentrantLock(); </span><span class="c17">// cre&#259;m blocarea</span><span
                        class="c4"><br> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c5">for</span><span
                        class="c4">&nbsp;(</span><span class="c5">int</span><span class="c4">&nbsp;i = </span><span
                        class="c0">1</span><span class="c4">; i &lt; </span><span class="c0">6</span><span class="c4">;
                        i++) {<br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br> &nbsp; &nbsp; &nbsp; &nbsp;
                        &nbsp; &nbsp;Thread t = </span><span class="c5">new</span><span
                        class="c4">&nbsp;Thread(</span><span class="c5">new</span><span
                        class="c4">&nbsp;CountThread(commonResource, locker));<br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
                        &nbsp;t.setName(</span><span class="c13">&quot;Thread &quot;</span><span class="c4">&nbsp;+
                        i);<br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;t.start();<br> &nbsp; &nbsp; &nbsp; &nbsp;}<br>
                        &nbsp; &nbsp;}<br>}<br> &nbsp;<br></span><span class="c5">class</span><span
                        class="c4">&nbsp;</span><span class="c8">CommonResource</span><span class="c4">&nbsp;{<br>
                        &nbsp; &nbsp;</span><span class="c5">int</span><span class="c4">&nbsp;x = </span><span
                        class="c0">0</span><span class="c4">;<br>}<br> &nbsp;<br></span><span
                        class="c5">class</span><span class="c4">&nbsp;</span><span class="c8">CountThread</span><span
                        class="c4">&nbsp;</span><span class="c5">implements</span><span class="c4">&nbsp;</span><span
                        class="c8">Runnable</span><span class="c4">&nbsp;{<br> &nbsp;<br> &nbsp; &nbsp;CommonResource
                        res;<br> &nbsp; &nbsp;ReentrantLock locker;<br> &nbsp; &nbsp;CountThread(CommonResource res,
                        ReentrantLock lock) {<br> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c5">this</span><span
                        class="c4">.res = res;<br> &nbsp; &nbsp; &nbsp; &nbsp;locker = lock;<br> &nbsp; &nbsp;}<br>
                        &nbsp; &nbsp;</span><span class="c5">public</span><span class="c4">&nbsp;</span><span
                        class="c5">void</span><span class="c4">&nbsp;</span><span class="c8">run</span><span
                        class="c4">() {<br> &nbsp; &nbsp; &nbsp; &nbsp; <br> &nbsp; &nbsp; &nbsp; &nbsp;locker.lock();
                    </span><span class="c17">// aplic&#259;m blocarea</span><span class="c4"><br> &nbsp; &nbsp; &nbsp;
                        &nbsp;</span><span class="c5">try</span><span class="c4">&nbsp;{<br> &nbsp; &nbsp; &nbsp; &nbsp;
                        &nbsp; &nbsp;res.x = </span><span class="c0">1</span><span class="c4">;<br> &nbsp; &nbsp; &nbsp;
                        &nbsp; &nbsp; &nbsp;</span><span class="c5">for</span><span class="c4">&nbsp;(</span><span
                        class="c5">int</span><span class="c4">&nbsp;i = </span><span class="c0">1</span><span
                        class="c4">; i &lt; </span><span class="c0">5</span><span class="c4">; i++) {<br> &nbsp; &nbsp;
                        &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;System.out.printf(</span><span class="c13">&quot;%s %d
                        \n&quot;</span><span class="c4">, Thread.currentThread().getName(), res.x);<br> &nbsp; &nbsp;
                        &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;res.x++;<br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
                        &nbsp; &nbsp;Thread.sleep(</span><span class="c0">100</span><span class="c4">);<br> &nbsp;
                        &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;}<br> &nbsp; &nbsp; &nbsp; &nbsp;}<br> &nbsp; &nbsp; &nbsp;
                        &nbsp;</span><span class="c5">catch</span><span class="c4">&nbsp;(InterruptedException e) {<br>
                        &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;System.out.println(e.getMessage());<br> &nbsp; &nbsp;
                        &nbsp; &nbsp;}<br> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c5">finally</span><span
                        class="c4">&nbsp;{<br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;locker.unlock(); </span><span
                        class="c17">// eliber&#259;m blocarea</span><span class="c4"><br> &nbsp; &nbsp; &nbsp;
                        &nbsp;}<br> &nbsp; &nbsp;}<br>}</span></p>
            </td>
        </tr>
    </table>
    <p class="c1"><span class="c2"></span></p>
    <p class="c11"><span class="c2">Aici se folose&#537;te &#537;i resursa comun&#259; CommonResource, pentru
            gestionarea c&#259;reia se creeaz&#259; cinci fire de execu&#539;ie. La intrarea &icirc;n sec&#539;iunea
            critic&#259; se aplic&#259; blocarea:</span></p>
    <p class="c1"><span class="c2"></span></p>
    <table class="c16">
        <tr class="c12">
            <td class="c7" colspan="1" rowspan="1">
                <p class="c18"><span class="c4">locker.lock();</span></p>
            </td>
        </tr>
    </table>
    <p class="c1"><span class="c2"></span></p>
    <p class="c11"><span class="c2">Dup&#259; aceasta, doar un fir de execu&#539;ie are acces la sec&#539;iunea
            critic&#259;, iar celelalte fire a&#537;teapt&#259; eliberarea bloc&#259;rii. &Icirc;n blocul finally,
            dup&#259; ce firul de execu&#539;ie &#537;i-a &icirc;ncheiat activitatea principal&#259;, blocarea este
            eliberat&#259;. Acest lucru se face neap&#259;rat &icirc;n blocul finally, deoarece &icirc;n cazul
            apari&#539;iei unei erori, toate celelalte fire ar r&#259;m&acirc;ne blocate.</span></p>
    <p class="c1"><span class="c2"></span></p>
    <p class="c11"><span class="c2">&Icirc;n final, vom ob&#539;ine un rezultat similar cu cel ob&#539;inut &icirc;n
            cazul folosirii operatorului synchronized:</span></p>
    <p class="c1"><span class="c2"></span></p>
    <table class="c16">
        <tr class="c12">
            <td class="c7" colspan="1" rowspan="1">
                <p class="c18"><span class="c4">Thread </span><span class="c0">4</span><span
                        class="c4">&nbsp;</span><span class="c0">1</span><span class="c4">&nbsp;<br>Thread </span><span
                        class="c0">4</span><span class="c4">&nbsp;</span><span class="c0">2</span><span
                        class="c4">&nbsp;<br>Thread </span><span class="c0">4</span><span class="c4">&nbsp;</span><span
                        class="c0">3</span><span class="c4">&nbsp;<br>Thread </span><span class="c0">4</span><span
                        class="c4">&nbsp;</span><span class="c0">4</span><span class="c4">&nbsp;<br>Thread </span><span
                        class="c0">3</span><span class="c4">&nbsp;</span><span class="c0">1</span><span
                        class="c4">&nbsp;<br>Thread </span><span class="c0">3</span><span class="c4">&nbsp;</span><span
                        class="c0">2</span><span class="c4">&nbsp;<br>Thread </span><span class="c0">3</span><span
                        class="c4">&nbsp;</span><span class="c0">3</span><span class="c4">&nbsp;<br>Thread </span><span
                        class="c0">3</span><span class="c4">&nbsp;</span><span class="c0">4</span><span
                        class="c4">&nbsp;<br>Thread </span><span class="c0">2</span><span class="c4">&nbsp;</span><span
                        class="c0">1</span><span class="c4">&nbsp;<br>Thread </span><span class="c0">2</span><span
                        class="c4">&nbsp;</span><span class="c0">2</span><span class="c4">&nbsp;<br>Thread </span><span
                        class="c0">2</span><span class="c4">&nbsp;</span><span class="c0">3</span><span
                        class="c4">&nbsp;<br>Thread </span><span class="c0">2</span><span class="c4">&nbsp;</span><span
                        class="c0">4</span><span class="c4">&nbsp;<br>Thread </span><span class="c0">1</span><span
                        class="c4">&nbsp;</span><span class="c0">1</span><span class="c4">&nbsp;<br>Thread </span><span
                        class="c0">1</span><span class="c4">&nbsp;</span><span class="c0">2</span><span
                        class="c4">&nbsp;<br>Thread </span><span class="c0">1</span><span class="c4">&nbsp;</span><span
                        class="c0">3</span><span class="c4">&nbsp;<br>Thread </span><span class="c0">1</span><span
                        class="c4">&nbsp;</span><span class="c0">4</span><span class="c4">&nbsp;<br>Thread </span><span
                        class="c0">5</span><span class="c4">&nbsp;</span><span class="c0">1</span><span
                        class="c4">&nbsp;<br>Thread </span><span class="c0">5</span><span class="c4">&nbsp;</span><span
                        class="c0">2</span><span class="c4">&nbsp;<br>Thread </span><span class="c0">5</span><span
                        class="c4">&nbsp;</span><span class="c0">3</span><span class="c4">&nbsp;<br>Thread </span><span
                        class="c0">5</span><span class="c4">&nbsp;</span><span class="c0">4</span></p>
            </td>
        </tr>
    </table>
    <p class="c1"><span class="c2"></span></p>
    <p class="c1"><span class="c2"></span></p>
</body>

</html>