<html>

<head>
    <meta content="text/html; charset=UTF-8" http-equiv="content-type">
    <link rel="stylesheet" type="text/css" href="/lessons/styles.css">
</head>

<body class="c14 doc-content">
    <h1 class="c0 c13">Utilizarea Promise în solicitările Ajax. </h1>
    <p class="c0 c6"><span class="c4"></span></p>
    <p class="c0"><span class="c4">Dup&#259; cum se poate vedea din exemplele temelor anterioare pentru crearea
            solicit&#259;rilor ajax sunt utilizate apeluri practic repetitive, care difer&#259; doar prin detalii -
            &#537;irul solicit&#259;rii, func&#539;iile de procesare a r&#259;spunsului. Ar fi foarte util s&#259;
            cre&#259;m o abstrac&#539;ie comun&#259; pentru toate ac&#539;iunile legate de solicitarea ajax
            asincron&#259; &#537;i apoi s&#259; o folosim la urm&#259;toarele apeluri c&#259;tre server.</span></p>
    <p class="c0 c6"><span class="c4"></span></p>
    <p class="c0"><span class="c8">Pentru crearea unui nivel suplimentar de abstrac&#539;ie &icirc;n acest caz, este
            convenabil s&#259; utiliz&#259;m obiectul </span><span class="c15">Promise</span><span class="c4">, care
            &icirc;mpacheteaz&#259; o opera&#539;ie asincron&#259; &icirc;ntr-un singur obiect, permi&#539;&acirc;nd
            definirea ac&#539;iunilor care se execut&#259; la finalizarea cu succes sau e&#537;ecul acelei
            opera&#539;ii.</span></p>
    <p class="c0 c6"><span class="c4"></span></p>
    <p class="c0"><span class="c4">&Icirc;ncapsul&#259;m solicitarea asincron&#259; &icirc;ntr-un obiect Promise:</span>
    </p>
    <p class="c0 c6"><span class="c4"></span></p><a id="t.b752713209473ebe2a3a158827a8af768d15a8c3"></a><a id="t.0"></a>
    <table class="c9">
        <tr class="c2">
            <td class="c12" colspan="1" rowspan="1">
                <p class="c11"><span class="c1">function</span><span class="c5">&nbsp;</span><span
                        class="c3">get</span><span class="c5">(url) {<br> &nbsp; &nbsp;</span><span
                        class="c1">return</span><span class="c5">&nbsp;</span><span class="c1">new</span><span
                        class="c5">&nbsp;</span><span class="c3">Promise</span><span class="c5">((succeed, fail) =&gt;
                        {<br> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c1">const</span><span class="c5">&nbsp;xhr
                        = </span><span class="c1">new</span><span class="c5">&nbsp;XMLHttpRequest();<br> &nbsp; &nbsp;
                        &nbsp; &nbsp;xhr.open(</span><span class="c7">&quot;GET&quot;</span><span class="c5">, url);<br>
                        &nbsp; &nbsp; &nbsp; &nbsp;xhr.addEventListener(</span><span
                        class="c7">&quot;load&quot;</span><span class="c5">, () =&gt; {<br> &nbsp; &nbsp; &nbsp; &nbsp;
                        &nbsp; &nbsp;</span><span class="c1">if</span><span class="c5">&nbsp;(xhr.status &gt;=
                    </span><span class="c8 c10">200</span><span class="c5">&nbsp;&amp;&amp; xhr.status &lt; </span><span
                        class="c8 c10">400</span><span class="c5">)<br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
                        &nbsp;succeed(xhr.response);<br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span
                        class="c1">else</span><span class="c5"><br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
                        &nbsp;fail(</span><span class="c1">new</span><span class="c5">&nbsp;</span><span
                        class="c3">Error</span><span class="c5">(</span><span class="c7">`Solicitarea a e&#537;uat:
                        ${xhr.statusText}`</span><span class="c5">));<br> &nbsp; &nbsp; &nbsp; &nbsp;});<br> &nbsp;
                        &nbsp; &nbsp; &nbsp;xhr.addEventListener(</span><span class="c7">&quot;error&quot;</span><span
                        class="c5">, () =&gt; fail(</span><span class="c1">new</span><span class="c5">&nbsp;</span><span
                        class="c3">Error</span><span class="c5">(</span><span class="c7">&quot;Eroare de
                        re&#539;ea&quot;</span><span class="c5">)));<br> &nbsp; &nbsp; &nbsp; &nbsp;xhr.send();<br>
                        &nbsp; &nbsp;});<br>}</span></p>
            </td>
        </tr>
    </table>
    <p class="c0 c6"><span class="c4"></span></p>
    <p class="c0"><span class="c4">Metoda get prime&#537;te ca parametru adresa resursei serverului &#537;i
            returneaz&#259; un obiect Promise. Constructorul Promise prime&#537;te ca parametru o func&#539;ie callback,
            care, la r&acirc;ndul s&#259;u, accept&#259; doi parametri - dou&#259; func&#539;ii: una se execut&#259; la
            procesarea cu succes a solicit&#259;rii, iar cealalt&#259; - la e&#537;ec.</span></p>
    <p class="c0 c6"><span class="c4"></span></p>
    <p class="c0"><span class="c4">S&#259; presupunem c&#259; serverul este o aplica&#539;ie simpl&#259; Node.js:</span>
    </p>
    <p class="c0 c6"><span class="c4"></span></p><a id="t.618a39dc1bcb450b85ad3dea6f2872c0e411b347"></a><a id="t.1"></a>
    <table class="c9">
        <tr class="c2">
            <td class="c12" colspan="1" rowspan="1">
                <p class="c11"><span class="c1">const</span><span class="c5">&nbsp;http = </span><span
                        class="c3">require</span><span class="c5">(</span><span class="c7">&quot;http&quot;</span><span
                        class="c5">);<br></span><span class="c1">const</span><span class="c5">&nbsp;fs = </span><span
                        class="c3">require</span><span class="c5">(</span><span class="c7">&quot;fs&quot;</span><span
                        class="c5">);<br><br>http.createServer(</span><span class="c1">function</span><span
                        class="c5">(request, response){<br> &nbsp; &nbsp; <br> &nbsp; &nbsp;</span><span
                        class="c1">if</span><span class="c5">(request.url == </span><span
                        class="c7">&quot;/hello&quot;</span><span class="c5">){<br> &nbsp; &nbsp; &nbsp;
                        &nbsp;response.end(</span><span class="c7">&quot;XMLHttpRequest pe FDC.COM&quot;</span><span
                        class="c5">);<br> &nbsp; &nbsp;}<br> &nbsp; &nbsp;</span><span class="c1">else</span><span
                        class="c5">{<br> &nbsp; &nbsp; &nbsp; &nbsp;fs.readFile(</span><span
                        class="c7">&quot;index.html&quot;</span><span class="c5">, (_error, data) =&gt;
                        response.end(data));<br> &nbsp; &nbsp;}<br>}).listen(</span><span
                        class="c8 c10">3000</span><span class="c5">, () =&gt; </span><span
                        class="c3">console</span><span class="c5">.log(</span><span class="c7">&quot;Serverul a fost
                        lansat la adresa http://localhost:3000&quot;</span><span class="c5">));</span></p>
            </td>
        </tr>
    </table>
    <p class="c0 c6"><span class="c4"></span></p>
    <p class="c0"><span class="c4">Acum apel&#259;m metoda get pentru a efectua o solicitare c&#259;tre server:</span>
    </p>
    <p class="c0 c6"><span class="c4"></span></p><a id="t.6a25a21ff963f5840cfe5299c511f4c69e29efe0"></a><a id="t.2"></a>
    <table class="c9">
        <tr class="c2">
            <td class="c12" colspan="1" rowspan="1">
                <p class="c11"><span class="c5">get(</span><span
                        class="c7">&quot;http://localhost:3000/hello&quot;</span><span class="c5">)<br> &nbsp;
                        &nbsp;.then(response =&gt; </span><span class="c3">console</span><span
                        class="c5">.log(response))<br> &nbsp; &nbsp;.catch(error =&gt; </span><span
                        class="c3">console</span><span class="c5">.error(error));</span></p>
            </td>
        </tr>
    </table>
    <p class="c0 c6"><span class="c4"></span></p>
    <p class="c0"><span class="c8">Pentru a procesa rezultatul obiectului Promise se apeleaz&#259; metoda </span><span
            class="c15">then()</span><span class="c4">, care accept&#259; doi parametri: o func&#539;ie care se
            apeleaz&#259; la finalizarea cu succes a solicit&#259;rii &#537;i o func&#539;ie care se apeleaz&#259; la
            e&#537;ec.</span></p>
    <p class="c0 c6"><span class="c4"></span></p>
    <p class="c0"><span class="c4">&Icirc;n acest caz, func&#539;ia din primul apel al metodei then prime&#537;te
            r&#259;spunsul serverului &#537;i &icirc;l afi&#537;eaz&#259; pe consol&#259;.</span></p>
    <p class="c0 c6"><span class="c4"></span></p>
    <p class="c0"><span class="c8">Pentru gestionarea erorilor, putem folosi metoda </span><span
            class="c15">catch()</span><span class="c4">, &icirc;n care se transmite func&#539;ia de procesare a
            erorilor.</span></p>
    <p class="c0 c6"><span class="c4"></span></p>
    <p class="c0"><span class="c4">&Icirc;ntr-un mod similar, putem trimite date c&#259;tre server folosind
            Promise:</span></p>
    <p class="c0 c6"><span class="c4"></span></p><a id="t.2b1528ae6af01a35b2f4e71ea4d413cead6bfba6"></a><a id="t.3"></a>
    <table class="c9">
        <tr class="c2">
            <td class="c12" colspan="1" rowspan="1">
                <p class="c11"><span class="c1">function</span><span class="c5">&nbsp;</span><span
                        class="c3">post</span><span class="c5">(url, data) {<br> &nbsp; &nbsp;</span><span
                        class="c1">return</span><span class="c5">&nbsp;</span><span class="c1">new</span><span
                        class="c5">&nbsp;</span><span class="c3">Promise</span><span class="c5">((succeed, fail) =&gt;
                        {<br> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c1">const</span><span class="c5">&nbsp;xhr
                        = </span><span class="c1">new</span><span class="c5">&nbsp;XMLHttpRequest();<br> &nbsp; &nbsp;
                        &nbsp; &nbsp;xhr.open(</span><span class="c7">&quot;POST&quot;</span><span class="c5">,
                        url);<br> &nbsp; &nbsp; &nbsp; &nbsp;xhr.addEventListener(</span><span
                        class="c7">&quot;load&quot;</span><span class="c5">, () =&gt; {<br> &nbsp; &nbsp; &nbsp; &nbsp;
                        &nbsp; &nbsp;</span><span class="c1">if</span><span class="c5">&nbsp;(xhr.status &gt;=
                    </span><span class="c8 c10">200</span><span class="c5">&nbsp;&amp;&amp; xhr.status &lt; </span><span
                        class="c8 c10">400</span><span class="c5">)<br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
                        &nbsp;succeed(xhr.response);<br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span
                        class="c1">else</span><span class="c5"><br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
                        &nbsp;fail(</span><span class="c1">new</span><span class="c5">&nbsp;</span><span
                        class="c3">Error</span><span class="c5">(</span><span class="c7">`Solicitarea a e&#537;uat:
                        ${xhr.statusText}`</span><span class="c5">));<br> &nbsp; &nbsp; &nbsp; &nbsp;});<br> &nbsp;
                        &nbsp; &nbsp; &nbsp;xhr.addEventListener(</span><span class="c7">&quot;error&quot;</span><span
                        class="c5">, () =&gt; fail(</span><span class="c1">new</span><span class="c5">&nbsp;</span><span
                        class="c3">Error</span><span class="c5">(</span><span class="c7">&quot;Eroare de
                        re&#539;ea&quot;</span><span class="c5">)));<br> &nbsp; &nbsp; &nbsp; &nbsp;xhr.send(data);<br>
                        &nbsp; &nbsp;});<br>}<br>post(</span><span
                        class="c7">&quot;http://localhost:3000/user&quot;</span><span class="c5">, </span><span
                        class="c7">&quot;Tom&quot;</span><span class="c5">)<br> &nbsp; &nbsp;.then(response =&gt;
                    </span><span class="c3">console</span><span class="c5">.log(response))<br> &nbsp; &nbsp;.catch(error
                        =&gt; </span><span class="c3">console</span><span class="c5">.error(error));</span></p>
            </td>
        </tr>
    </table>
    <p class="c0 c6"><span class="c4"></span></p>
    <p class="c0"><span class="c4">&Icirc;n acest caz, la adresa &quot;http://localhost:3000/user&quot; va fi trimis
            &#537;irul &quot;Tom&quot;.</span></p>
    <p class="c0 c6"><span class="c4"></span></p>
</body>

</html>