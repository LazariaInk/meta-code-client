<html>

<head>
    <meta content="text/html; charset=UTF-8" http-equiv="content-type">
    <link rel="stylesheet" type="text/css" href="/lessons/styles.css">
</head>

<body class="c19 doc-content">
    <h1 class="c0 c11 c17">IndexDB API. </h1>
    <p class="c0 c7"><span class="c11 c2"></span></p>
    <p class="c0"><span class="c8">Crearea, deschiderea &#537;i &#537;tergerea bazei de date.</span></p>
    <p class="c0 c7"><span class="c3"></span></p>
    <p class="c0"><span class="c2">Indexed Database API </span><span class="c13">sau</span><span
            class="c2">&nbsp;IndexedDB API </span><span class="c13">ofer&#259; func&#539;ionalit&#259;&#539;i pentru
            lucrul cu o baz&#259; de date care se afl&#259; &icirc;n browser. Aceast&#259; baz&#259; de date se
            nume&#537;te </span><span class="c2">IndexedDB</span><span class="c3">. Particularitatea sa este c&#259;
            este o baz&#259; de date nere&#539;inut&#259; (ceea ce se nume&#537;te NoSQL). Ideea principal&#259; a
            IndexedDB const&#259; &icirc;n stocarea obiectelor sub anumite chei.</span></p>
    <p class="c0 c7"><span class="c3"></span></p>
    <p class="c0"><span class="c11 c8">Deschiderea/crearea bazei de date IndexDB.</span></p>
    <p class="c0 c7"><span class="c11 c2"></span></p>
    <p class="c0"><span class="c13">Pentru a accesa func&#539;ionalitatea IndexedDB se utilizeaz&#259; proprietatea
        </span><span class="c2">indexedDB </span><span class="c13">a obiectului </span><span
            class="c2">window</span><span class="c3">:</span></p>
    <p class="c0 c7"><span class="c3"></span></p><a id="t.ad989f342cdb5f0dcfb992335636adcf9a2472df"></a><a id="t.0"></a>
    <table class="c18">
        <tr class="c15">
            <td class="c12" colspan="1" rowspan="1">
                <p class="c10"><span class="c13 c16">const</span><span class="c6">&nbsp;dbFactory = </span><span
                        class="c1">window</span><span class="c6">.indexedDB;<br></span><span
                        class="c1">console</span><span class="c6">.log(dbFactory); &nbsp; &nbsp;</span><span
                        class="c5">// IDBFactory{}</span></p>
            </td>
        </tr>
    </table>
    <p class="c0 c7"><span class="c3"></span></p>
    <p class="c0"><span class="c13">Aceast&#259; proprietate reprezint&#259; un obiect de tip </span><span
            class="c2">IDBFactory</span><span class="c13">, care ofer&#259; func&#539;ionalitatea pentru lucrul cu baza
            de date. &Icirc;n special, cu ajutorul metodei sale</span><span class="c2">&nbsp;open()</span><span
            class="c3">&nbsp;se poate deschide o baz&#259; de date.</span></p>
    <p class="c0 c7"><span class="c3"></span></p><a id="t.2551be2cad249e8f325511ed723373a0a45cd826"></a><a id="t.1"></a>
    <table class="c18">
        <tr class="c15">
            <td class="c12" colspan="1" rowspan="1">
                <p class="c10"><span class="c6">open(name)<br>open(name, version)</span></p>
            </td>
        </tr>
    </table>
    <p class="c0 c7"><span class="c3"></span></p>
    <p class="c0"><span class="c13">Ca parametru &icirc;n metoda </span><span class="c13 c14">open()</span><span
            class="c3">&nbsp;se transmite numele bazei de date. Ca al doilea parametru op&#539;ional se poate transmite
            num&#259;rul versiunii bazei de date, care, de fapt, define&#537;te schema bazei de date utilizat&#259;
            pentru stocarea obiectelor.</span></p>
    <p class="c0 c7"><span class="c3"></span></p><a id="t.28398d9f39355a2dc1ffb63f30b17b4f037d60a0"></a><a id="t.2"></a>
    <table class="c18">
        <tr class="c15">
            <td class="c12" colspan="1" rowspan="1">
                <p class="c10"><span class="c13 c16">const</span><span class="c6">&nbsp;request =
                        indexedDB.open(</span><span class="c9">&quot;test&quot;</span><span class="c6">); </span><span
                        class="c5">// ne conect&#259;m la bd test</span></p>
            </td>
        </tr>
    </table>
    <p class="c0 c7"><span class="c3"></span></p>
    <p class="c0"><span class="c3">&Icirc;n acest cod &icirc;ncerc&#259;m s&#259; ne conect&#259;m la baza de date
            &quot;test&quot;. &#536;i nu conteaz&#259; c&#259; ini&#539;ial aceast&#259; baz&#259; de date nu
            exist&#259; - dac&#259; lipse&#537;te, ea este automat creat&#259;.</span></p>
    <p class="c0 c7"><span class="c3"></span></p>
    <p class="c0"><span class="c13">Valoarea returnat&#259; de metoda </span><span class="c13 c14">open() </span><span
            class="c13">este un obiect de tip </span><span class="c2">IDBOpenDBRequest</span><span class="c3">. Se poate
            spune c&#259; acesta este un obiect de cerere pentru deschiderea corespunz&#259;toare a bazei de
            date.</span></p>
    <p class="c0 c7"><span class="c3"></span></p>
    <p class="c0"><span class="c13">Pentru a accesa baza de date propriu-zis&#259; la obiectul IDBOpenDBRequest se poate
            procesa evenimentul </span><span class="c2">success</span><span class="c13">. Acesta apare la deschiderea cu
            succes a bazei de date. Pentru a seta un handler pentru acest eveniment se poate folosi proprietatea
        </span><span class="c2">onsuccess</span><span class="c3">:</span></p>
    <p class="c0 c7"><span class="c3"></span></p><a id="t.f0341608382bbfa39930682efeaccafc23f6a335"></a><a id="t.3"></a>
    <table class="c18">
        <tr class="c15">
            <td class="c12" colspan="1" rowspan="1">
                <p class="c10"><span class="c13 c16">const</span><span class="c6">&nbsp;request =
                        indexedDB.open(</span><span class="c9">&quot;test&quot;</span><span class="c6">); </span><span
                        class="c5">// ne conect&#259;m la bd test</span><span class="c6"><br></span><span class="c5">//
                        la deschiderea reu&#537;it&#259; se activeaz&#259; evenimentul success</span><span
                        class="c6"><br></span><span class="c5">// proces&#259;m acest eveniment</span><span
                        class="c6"><br>request.onsuccess = (event) =&gt; { &nbsp;<br> &nbsp; &nbsp;</span><span
                        class="c13 c16">const</span><span class="c6">&nbsp;database = event.target.result;
                        &nbsp;</span><span class="c5">// acces&#259;m baza de date &nbsp;</span><span class="c6"><br>
                        &nbsp; &nbsp;</span><span class="c1">console</span><span class="c6">.log(database.name); &nbsp;
                        &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c5">// &quot;Test&quot; &nbsp;</span><span
                        class="c6"><br>};</span></p>
            </td>
        </tr>
    </table>
    <p class="c0 c7"><span class="c3"></span></p>
    <p class="c0"><span class="c13">&Icirc;n interiorul handlerului evenimentului, prin proprietatea</span><span
            class="c13 c14">&nbsp;event.target.result</span><span class="c13">&nbsp;putem ob&#539;ine baza de date, care
            reprezint&#259; un obiect </span><span class="c2">IDBDatabase</span><span class="c3">.</span></p>
    <p class="c0 c7"><span class="c3"></span></p>
    <p class="c0"><span class="c11 c8">Procesarea erorilor la deschiderea bazei de date.</span></p>
    <p class="c0 c7"><span class="c2 c11"></span></p>
    <p class="c0"><span class="c13">Totu&#537;i, la &icirc;ncercarea de a deschide baza de date poate ap&#259;rea
            &#537;i o eroare - evenimentul </span><span class="c2">error</span><span class="c13">, de exemplu,
            c&acirc;nd utilizatorul nu are permisiuni &icirc;n browser pentru acces la baza de date. &Icirc;n acest caz
            putem defini un handler pentru evenimentul error prin proprietatea </span><span
            class="c2">onerror</span><span class="c3">:</span></p>
    <p class="c0 c7"><span class="c3"></span></p><a id="t.740f44c7c390e67539c8c63164a272448d3c4282"></a><a id="t.4"></a>
    <table class="c18">
        <tr class="c15">
            <td class="c12" colspan="1" rowspan="1">
                <p class="c10"><span class="c13 c16">const</span><span class="c6">&nbsp;request =
                        indexedDB.open(</span><span class="c9">&quot;test&quot;</span><span class="c6">); </span><span
                        class="c5">// ne conect&#259;m la bd test</span><span class="c6"><br></span><span class="c5">//
                        proces&#259;m eroarea</span><span class="c6"><br>request.onerror = (event) =&gt; {<br> &nbsp;
                        &nbsp;</span><span class="c13 c16">const</span><span class="c6">&nbsp;error =
                        event.target.error; &nbsp; &nbsp; &nbsp;</span><span class="c5">// Ob&#539;inem informa&#539;ii
                        despre eroare &nbsp;</span><span class="c6"><br> &nbsp; &nbsp;</span><span
                        class="c1">console</span><span class="c6">.error(error.message);<br>};</span></p>
            </td>
        </tr>
    </table>
    <p class="c0 c7"><span class="c3"></span></p>
    <p class="c0"><span class="c11 c8">Urm&#259;rirea cre&#259;rii bazei de date.</span></p>
    <p class="c0 c7"><span class="c11 c2"></span></p>
    <p class="c0"><span class="c13">La deschiderea bazei de date, dac&#259; aceasta lipse&#537;te, ea este automat
            creat&#259;. Prin urmare, &icirc;n acest sens nu conteaz&#259; dac&#259; avem sau nu baza de date.
            Totu&#537;i, uneori este necesar s&#259; urm&#259;rim crearea bazei de date. &Icirc;n acest caz putem folosi
            evenimentul </span><span class="c2">upgradeneeded</span><span class="c13">, care este apelat de fiecare
            dat&#259; c&acirc;nd baza de date solicitat&#259; &icirc;nc&#259; nu exist&#259; &#537;i prin urmare este
            creat&#259;, sau c&acirc;nd baza de date solicitat&#259; &icirc;nc&#259; nu exist&#259; &icirc;n
            aceast&#259; versiune specific&#259;. &Icirc;n ambele cazuri, handlerul evenimentului apelat prime&#537;te
            ca parametru un obiect de tip </span><span class="c13 c14">IDBVersionChangeEvent</span><span class="c13">.
            Acest obiect permite ob&#539;inerea versiunii vechi &#537;i a celei noi a bd. Pentru a seta un handler
            pentru eveniment se poate folosi proprietatea </span><span class="c13 c14">onupgradeneeded</span><span
            class="c3">:</span></p>
    <p class="c0 c7"><span class="c3"></span></p><a id="t.06eb419521bbb2f2685c007f8a4e5bec8448cfc1"></a><a id="t.5"></a>
    <table class="c18">
        <tr class="c15">
            <td class="c12" colspan="1" rowspan="1">
                <p class="c10"><span class="c6">request.onupgradeneeded = (event) =&gt; { <br> &nbsp; &nbsp;</span><span
                        class="c1">console</span><span class="c6">.log(event.oldVersion); &nbsp; &nbsp; &nbsp; &nbsp;
                    </span><span class="c5">// versiunea veche a bazei de date </span><span class="c6"><br> &nbsp;
                        &nbsp;</span><span class="c1">console</span><span class="c6">.log(event.newVersion); &nbsp;
                        &nbsp; &nbsp; &nbsp; </span><span class="c5">// versiunea nou&#259; a bazei de date </span><span
                        class="c6"><br> &nbsp; &nbsp;</span><span class="c13 c16">const</span><span
                        class="c6">&nbsp;database = event.target.result; &nbsp;</span><span class="c5">// acces&#259;m
                        baza de date propriu-zis&#259;</span><span class="c6"><br>};</span></p>
            </td>
        </tr>
    </table>
    <p class="c0 c7"><span class="c3"></span></p>
    <p class="c0"><span class="c3">Deoarece acest handler este apelat la crearea bazei de date, el reprezint&#259; un
            loc convenabil pentru efectuarea diferitelor set&#259;ri &#537;i ini&#539;ializ&#259;ri ale bd, &icirc;n
            special, pentru crearea spa&#539;iilor de stocare ale acesteia.</span></p>
    <p class="c0 c7"><span class="c3"></span></p>
    <p class="c0"><span class="c11 c8">Ob&#539;inerea bazelor de date.</span></p>
    <p class="c0 c7"><span class="c3"></span></p>
    <p class="c0"><span class="c13">Metoda </span><span class="c2">databases()</span><span class="c13">&nbsp;a
            obiectului </span><span class="c13 c14">IDBFactory </span><span class="c13">permite ob&#539;inerea unei
            liste a tuturor bazelor de date existente. Aceast&#259; metod&#259; returneaz&#259; un promise, din care se
            pot ob&#539;ine date sub forma unui array, unde fiecare element reprezint&#259; un obiect cu dou&#259;
            propriet&#259;&#539;i - </span><span class="c13 c14">name </span><span class="c13">(numele bazei de date)
            &#537;i </span><span class="c13 c14">version </span><span class="c3">(versiunea bazei de date):</span></p>
    <p class="c0 c7"><span class="c3"></span></p><a id="t.eb7396d55b5fc6b5829b141779a3642f88758a88"></a><a id="t.6"></a>
    <table class="c18">
        <tr class="c15">
            <td class="c12" colspan="1" rowspan="1">
                <p class="c10"><span class="c13 c16">const</span><span class="c6">&nbsp;promise =
                        indexedDB.databases();<br>promise.then((databases) =&gt; </span><span
                        class="c1">console</span><span class="c6">.log(databases));</span></p>
            </td>
        </tr>
    </table>
    <p class="c0 c7"><span class="c3"></span></p>
    <p class="c0"><span class="c3">De exemplu, outputul &icirc;n cazul meu:</span></p>
    <p class="c0 c7"><span class="c3"></span></p><a id="t.53a16e727c3072bba1a844308a9972ec9038c800"></a><a id="t.7"></a>
    <table class="c18">
        <tr class="c15">
            <td class="c12" colspan="1" rowspan="1">
                <p class="c10"><span class="c6">(</span><span class="c4">2</span><span class="c6">) [{...},
                        {...}]<br></span><span class="c4">0</span><span class="c6">: {name: </span><span
                        class="c9">&#39;test&#39;</span><span class="c6">, version: </span><span
                        class="c4">1</span><span class="c6">}<br></span><span class="c4">1</span><span class="c6">:
                        {name: </span><span class="c9">&#39;test2&#39;</span><span class="c6">, version: </span><span
                        class="c4">1</span><span class="c6">}<br>length: </span><span class="c4">2</span><span
                        class="c6"><br>[[Prototype]]: </span><span class="c1">Array</span><span class="c6">(</span><span
                        class="c4">0</span><span class="c6">)</span></p>
            </td>
        </tr>
    </table>
    <p class="c0 c7"><span class="c3"></span></p>
    <p class="c0"><span class="c3">&Icirc;n acest caz se vede c&#259; am dou&#259; baze de date - test &#537;i test2,
            fiecare av&acirc;nd versiunea 1.</span></p>
    <p class="c0 c7"><span class="c3"></span></p><a id="t.a3a72e42baa729b293d31db064a33978f7ac98ed"></a><a id="t.8"></a>
    <table class="c18">
        <tr class="c15">
            <td class="c12" colspan="1" rowspan="1">
                <p class="c10"><span class="c6">&#536;tergerea bazei de date</span></p>
            </td>
        </tr>
    </table>
    <p class="c0 c7"><span class="c3"></span></p>
    <p class="c0"><span class="c13">Pentru &#537;tergerea bazei de date la obiectul </span><span
            class="c13 c14">IDBFactory </span><span class="c13">se utilizeaz&#259; metoda </span><span
            class="c2">deleteDatabase()</span><span class="c3">, &icirc;n care se transmite numele bazei de date care
            urmeaz&#259; s&#259; fie &#537;tears&#259;:</span></p>
    <p class="c0 c7"><span class="c3"></span></p><a id="t.099f550578845498485f53b4b29c3bb63e041c97"></a><a id="t.9"></a>
    <table class="c18">
        <tr class="c15">
            <td class="c12" colspan="1" rowspan="1">
                <p class="c10"><span class="c6">indexedDB.deleteDatabase(</span><span
                        class="c9">&quot;test2&quot;</span><span class="c6">);</span></p>
            </td>
        </tr>
    </table>
    <p class="c0 c7"><span class="c3"></span></p>
    <p class="c0"><span class="c13">Este de men&#539;ionat c&#259; aceast&#259; metod&#259; ca rezultat returneaz&#259;
            un obiect </span><span class="c2">IDBOpenDBRequest </span><span class="c13">(men&#539;ionat mai sus). Astfel
            putem procesa evenimentele </span><span class="c13 c14">success </span><span class="c13">&#537;i
        </span><span class="c13 c14">error</span><span class="c3">, pentru a determina dac&#259; &#537;tergerea a avut
            loc cu succes sau a ap&#259;rut o eroare:</span></p>
    <p class="c0 c7"><span class="c3"></span></p><a id="t.45273f09f4a66928c217fbea96f445dbc56352a3"></a><a
        id="t.10"></a>
    <table class="c18">
        <tr class="c15">
            <td class="c12" colspan="1" rowspan="1">
                <p class="c10"><span class="c13 c16">const</span><span class="c6">&nbsp;DBDeleteRequest =
                        indexedDB.deleteDatabase(</span><span class="c9">&quot;test2&quot;</span><span class="c6">);<br>
                        <br>DBDeleteRequest.onerror = (event) =&gt; {<br> &nbsp;</span><span
                        class="c1">console</span><span class="c6">.error(</span><span class="c9">&quot;Error deleting
                        database.&quot;</span><span class="c6">);<br>};<br> <br>DBDeleteRequest.onsuccess = (event)
                        =&gt; {<br> &nbsp;</span><span class="c1">console</span><span class="c6">.log(</span><span
                        class="c9">&quot;Database deleted successfully&quot;</span><span class="c6">);<br> <br>
                        &nbsp;</span><span class="c1">console</span><span class="c6">.log(event.result); </span><span
                        class="c5">// ar trebui s&#259; fie undefined</span><span class="c6"><br>};</span></p>
            </td>
        </tr>
    </table>
    <p class="c0 c7"><span class="c3"></span></p>
    <p class="c0"><span class="c13">Dac&#259; baza de date a fost &#537;tears&#259; cu succes, atunci proprietatea
        </span><span class="c13 c14">result </span><span class="c13">a argumentului &icirc;n handlerul evenimentului
        </span><span class="c13 c14">success </span><span class="c3">nu va fi setat&#259;.</span></p>
    <p class="c0 c7"><span class="c3"></span></p>
    <p class="c0 c7"><span class="c3"></span></p>
</body>

</html>