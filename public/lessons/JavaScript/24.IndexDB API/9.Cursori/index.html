<html>

<head>
    <meta content="text/html; charset=UTF-8" http-equiv="content-type">
    <link rel="stylesheet" type="text/css" href="/lessons/styles.css">
</head>

<body class="c4 doc-content">
    <h1 class="c12 c11 c14">Cursori. </h1>
    <p class="c3"><span class="c11 c6"></span></p>
    <p class="c12"><span class="c6">Pentru a ob&#539;ine obiecte din depozitul bazei de date se pot utiliza &#537;i
        </span><span class="c2">cursorii</span><span class="c11 c6">. &Icirc;n contextul unei baze de date, un cursor
            reprezint&#259; un mecanism pentru a parcurge diferite obiecte din depozitul bazei de date.</span></p>
    <p class="c3"><span class="c11 c6"></span></p>
    <p class="c12"><span class="c6">Pentru a crea un cursor la obiectul </span><span class="c6 c7">IDBObjectStore
        </span><span class="c6">se folose&#537;te metoda </span><span class="c2">openCursor()</span><span
            class="c11 c6">:</span></p>
    <p class="c3"><span class="c11 c6"></span></p><a id="t.6c00e0d86d0265c97f87231cb77ea76dcbcdbef9"></a><a
        id="t.0"></a>
    <table class="c17">
        <tr class="c13">
            <td class="c18" colspan="1" rowspan="1">
                <p class="c15"><span class="c1">openCursor()<br>openCursor(query)<br>openCursor(query, direction)</span>
                </p>
            </td>
        </tr>
    </table>
    <p class="c3"><span class="c11 c6"></span></p>
    <p class="c12"><span class="c6">Ca parametru op&#539;ional, query &icirc;n metod&#259; se transmite cheia sau
            obiectul </span><span class="c2">IDBKeyRange</span><span class="c11 c6">, care define&#537;te un interval de
            chei. &Icirc;n acest caz, cursorul va trece doar prin obiectele cu aceste chei. Dac&#259; acest parametru nu
            este specificat, cursorul trece prin toate obiectele.</span></p>
    <p class="c3"><span class="c11 c6"></span></p>
    <p class="c12"><span class="c6">Al treilea parametru, </span><span class="c6 c7">direction</span><span
            class="c11 c6">, define&#537;te direc&#539;ia cursorului &#537;i poate avea urm&#259;toarele valori:</span>
    </p>
    <p class="c3"><span class="c11 c6"></span></p>
    <p class="c12"><span class="c6">- </span><span class="c2">next</span><span class="c11 c6">: cursorul &icirc;ncepe
            parcurgerea obiectelor de la &icirc;nceputul depozitului &icirc;n ordinea cresc&#259;toare a cheilor.
            Cursorul returneaz&#259; toate &icirc;nregistr&#259;rile din depozit, inclusiv duplicatele. Aceasta este
            valoarea implicit&#259;.</span></p>
    <p class="c3"><span class="c11 c6"></span></p>
    <p class="c12"><span class="c6">- </span><span class="c2">nextunique</span><span class="c11 c6">: cursorul
            &icirc;ncepe parcurgerea obiectelor de la &icirc;nceputul depozitului &icirc;n ordinea cresc&#259;toare a
            cheilor. Cursorul returneaz&#259; toate &icirc;nregistr&#259;rile din depozit, excluz&acirc;nd
            duplicatele.</span></p>
    <p class="c3"><span class="c11 c6"></span></p>
    <p class="c12"><span class="c6">- </span><span class="c2">prev</span><span class="c11 c6">: cursorul &icirc;ncepe
            parcurgerea obiectelor de la &icirc;nceputul depozitului &icirc;n ordinea descresc&#259;toare a cheilor.
            Cursorul returneaz&#259; toate &icirc;nregistr&#259;rile din depozit, inclusiv duplicatele.</span></p>
    <p class="c3"><span class="c11 c6"></span></p>
    <p class="c12"><span class="c6">- </span><span class="c2">prevunique</span><span class="c11 c6">: cursorul
            &icirc;ncepe parcurgerea obiectelor de la &icirc;nceputul depozitului &icirc;n ordinea descresc&#259;toare a
            cheilor. Cursorul returneaz&#259; toate &icirc;nregistr&#259;rile din depozit, excluz&acirc;nd
            duplicatele.</span></p>
    <p class="c3"><span class="c11 c6"></span></p>
    <p class="c12"><span class="c6">Metoda </span><span class="c6 c7">openCursor()</span><span
            class="c6">&nbsp;returneaz&#259; un obiect </span><span class="c2">IDBRequest</span><span class="c6">. La
            ob&#539;inerea cu succes a cursorului, la IDBRequest se declan&#537;eaz&#259; evenimentul </span><span
            class="c2">success</span><span class="c6">, iar proprietatea sa </span><span class="c2">result </span><span
            class="c6">reprezint&#259; fie valoarea </span><span class="c6 c7">IDBCursorWithValue </span><span
            class="c6">(dac&#259; cursorul a g&#259;sit obiecte &icirc;n depozit), fie </span><span class="c6 c7">null
        </span><span class="c6">(dac&#259; nu exist&#259; obiecte pentru cursor). Dac&#259; cursorul nu poate fi
            ob&#539;inut, se genereaz&#259; evenimentul </span><span class="c2">error</span><span class="c6">, iar
            proprietatea </span><span class="c6 c7">error </span><span class="c6">a obiectului IDBRequest con&#539;ine
            informa&#539;ii despre eroare. Pentru a gestiona aceste evenimente, se pot utiliza, respectiv,
            propriet&#259;&#539;ile </span><span class="c2">onsuccess </span><span class="c6">&#537;i </span><span
            class="c2">onerror</span><span class="c11 c6">.</span></p>
    <p class="c3"><span class="c11 c6"></span></p>
    <p class="c12"><span class="c6">La deschiderea cu succes a cursorului &#537;i prezen&#539;a obiectelor &icirc;n
            depozit pentru iterare, proprietatea </span><span class="c6 c7">result </span><span class="c6">a obiectului
            IDBRequest stocheaz&#259; valoarea </span><span class="c2">IDBCursorWithValue </span><span class="c11 c6">-
            acesta este chiar cursorul:</span></p>
    <p class="c3"><span class="c11 c6"></span></p><a id="t.54ea0217d26d8aae953f6961fe4191d222123b67"></a><a
        id="t.1"></a>
    <table class="c17">
        <tr class="c13">
            <td class="c18" colspan="1" rowspan="1">
                <p class="c15"><span class="c6 c9">const</span><span class="c1">&nbsp;request =
                        indexedDB.open(</span><span class="c5">&quot;test&quot;</span><span class="c1">, </span><span
                        class="c6 c8">6</span><span class="c1">); </span><span class="c0">// Conect&#259;m la baza de
                        date &quot;test&quot;</span><span class="c1"><br><br></span><span class="c0">// La crearea sau
                        modificarea versiunii bazei de date, cre&#259;m depozitul &quot;users&quot;</span><span
                        class="c1"><br>request.onupgradeneeded = (event) =&gt; { <br> &nbsp; &nbsp;</span><span
                        class="c6 c9">const</span><span class="c1">&nbsp;db = event.target.result; &nbsp;</span><span
                        class="c0">// Ob&#539;inem baza de date</span><span class="c1"><br> &nbsp; &nbsp;</span><span
                        class="c0">// Recre&#259;m depozitul &quot;users&quot; - &icirc;l &#537;tergem mai
                        &icirc;nt&acirc;i dac&#259; exist&#259;</span><span class="c1"><br> &nbsp;
                        &nbsp;db.deleteObjectStore(</span><span class="c5">&quot;users&quot;</span><span
                        class="c1">);<br> &nbsp; &nbsp;</span><span class="c0">// Cheia este proprietatea
                        &quot;id&quot;, &#537;i este autoincrementat&#259;</span><span class="c1"><br> &nbsp;
                        &nbsp;</span><span class="c6 c9">const</span><span class="c1">&nbsp;userStore =
                        db.createObjectStore(</span><span class="c5">&quot;users&quot;</span><span class="c1">, {
                        keyPath: </span><span class="c5">&quot;id&quot;</span><span class="c1">, autoIncrement:
                    </span><span class="c6 c9">true</span><span class="c1">&nbsp;});<br> &nbsp;
                        &nbsp;userStore.add({name: </span><span class="c5">&quot;Tom&quot;</span><span class="c1">, age:
                    </span><span class="c6 c8">39</span><span class="c1">});<br> &nbsp; &nbsp;userStore.add({name:
                    </span><span class="c5">&quot;Bob&quot;</span><span class="c1">, age: </span><span
                        class="c6 c8">43</span><span class="c1">});<br> &nbsp; &nbsp;userStore.add({name: </span><span
                        class="c5">&quot;Sam&quot;</span><span class="c1">, age: </span><span
                        class="c6 c8">28</span><span class="c1">});<br>};<br></span><span class="c0">// La deschiderea
                        bazei de date, ob&#539;inem un cursor</span><span class="c1"><br>request.onsuccess = (event)
                        =&gt; { <br> &nbsp; &nbsp;</span><span class="c6 c9">const</span><span class="c1">&nbsp;db =
                        event.target.result; &nbsp;</span><span class="c0">// Ob&#539;inem baza de date</span><span
                        class="c1"><br> &nbsp; &nbsp;</span><span class="c6 c9">const</span><span
                        class="c1">&nbsp;transaction = db.transaction([</span><span
                        class="c5">&quot;users&quot;</span><span class="c1">]); </span><span class="c0">// Cre&#259;m o
                        tranzac&#539;ie</span><span class="c1"><br> &nbsp; &nbsp;</span><span
                        class="c6 c9">const</span><span class="c1">&nbsp;userStore =
                        transaction.objectStore(</span><span class="c5">&quot;users&quot;</span><span class="c1">);
                        &nbsp; </span><span class="c0">// Ob&#539;inem depozitul &quot;users&quot;</span><span
                        class="c1"><br> &nbsp; &nbsp;</span><span class="c6 c9">const</span><span
                        class="c1">&nbsp;cursorRequest = userStore.openCursor(); </span><span class="c0">// Ob&#539;inem
                        o solicitare pentru deschiderea unui cursor</span><span class="c1"><br> &nbsp;
                        &nbsp;</span><span class="c0">// Ob&#539;inem cursorul</span><span class="c1"><br> &nbsp;
                        &nbsp;cursorRequest.onsuccess = () =&gt; {<br> &nbsp; &nbsp; &nbsp; &nbsp;</span><span
                        class="c6 c9">const</span><span class="c1">&nbsp;cursor = cursorRequest.result; &nbsp;
                        &nbsp;</span><span class="c0">// Poate fi ob&#539;inut &#537;i prin
                        event.target.result</span><span class="c1"><br> &nbsp; &nbsp; &nbsp; &nbsp;</span><span
                        class="c6 c10">console</span><span class="c1">.log(cursor); <br> &nbsp; &nbsp;}<br> &nbsp;
                        &nbsp;cursorRequest.onerror = () =&gt; &nbsp;</span><span class="c6 c10">console</span><span
                        class="c1">.log(cursorRequest.error);<br>};<br></span></p>
            </td>
        </tr>
    </table>
    <p class="c3"><span class="c11 c6"></span></p>
    <p class="c12"><span class="c6">La ob&#539;inerea cu succes a cursorului, proprietatea </span><span
            class="c6 c7">key </span><span class="c6">a obiectului IDBCursorWithValue va con&#539;ine cheia primului
            obiect din depozit, iar proprietatea </span><span class="c6 c7">value </span><span class="c11 c6">va
            con&#539;ine obiectul &icirc;nsu&#537;i.</span></p>
    <p class="c3"><span class="c11 c6"></span></p><a id="t.1992469b9a451c9e1584ea8de32105ba669b926e"></a><a
        id="t.2"></a>
    <table class="c17">
        <tr class="c13">
            <td class="c18" colspan="1" rowspan="1">
                <p class="c15"><span class="c1">request.onsuccess = (event) =&gt; { <br> &nbsp; &nbsp;</span><span
                        class="c6 c9">const</span><span class="c1">&nbsp;db = event.target.result; &nbsp;</span><span
                        class="c0">// Ob&#539;inem baza de date</span><span class="c1"><br> &nbsp; &nbsp;</span><span
                        class="c6 c9">const</span><span class="c1">&nbsp;transaction = db.transaction([</span><span
                        class="c5">&quot;users&quot;</span><span class="c1">]); </span><span class="c0">// Cre&#259;m o
                        tranzac&#539;ie</span><span class="c1"><br> &nbsp; &nbsp;</span><span
                        class="c6 c9">const</span><span class="c1">&nbsp;userStore =
                        transaction.objectStore(</span><span class="c5">&quot;users&quot;</span><span class="c1">);
                        &nbsp; </span><span class="c0">// Ob&#539;inem depozitul &quot;users&quot;</span><span
                        class="c1"><br> &nbsp; &nbsp;</span><span class="c6 c9">const</span><span
                        class="c1">&nbsp;cursorRequest = userStore.openCursor(); </span><span class="c0">// Ob&#539;inem
                        o solicitare pentru deschiderea unui cursor</span><span class="c1"><br> &nbsp;
                        &nbsp;</span><span class="c0">// Ob&#539;inem cursorul</span><span class="c1"><br> &nbsp;
                        &nbsp;cursorRequest.onsuccess = () =&gt; {<br> &nbsp; &nbsp; &nbsp; &nbsp;</span><span
                        class="c6 c9">const</span><span class="c1">&nbsp;cursor = cursorRequest.result; &nbsp;
                        &nbsp;</span><span class="c0">// De asemenea, poate fi ob&#539;inut prin
                        event.target.result</span><span class="c1"><br> &nbsp; &nbsp; &nbsp; &nbsp;</span><span
                        class="c6 c9">const</span><span class="c1">&nbsp;user = cursor.value; &nbsp; &nbsp;</span><span
                        class="c0">// Ob&#539;inem valoarea la care indic&#259; cursorul</span><span class="c1"><br>
                        &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c6 c10">console</span><span
                        class="c1">.log(user.id); &nbsp; &nbsp; &nbsp; </span><span class="c0">// Acesta este &#537;i
                        cursor.key </span><span class="c1"><br> &nbsp; &nbsp; &nbsp; &nbsp;</span><span
                        class="c6 c10">console</span><span class="c1">.log(user.name); <br> &nbsp; &nbsp; &nbsp;
                        &nbsp;</span><span class="c6 c10">console</span><span class="c1 c16">.log(user.age); <br> &nbsp;
                        &nbsp;}<br>};</span></p>
            </td>
        </tr>
    </table>
    <p class="c3"><span class="c11 c6"></span></p>
    <p class="c12"><span class="c6">Metoda </span><span class="c2">continue()</span><span
            class="c6">&nbsp;determin&#259; cursorul s&#259; se deplaseze la urm&#259;toarea &icirc;nregistrare
            (dac&#259; exist&#259;), ceea ce duce la reexecutarea handlerului </span><span class="c6 c7">onsuccess
        </span><span class="c11 c6">&#537;i a&#537;a mai departe. De exemplu, pentru a ob&#539;ine toate obiectele din
            depozitul users:</span></p>
    <p class="c3"><span class="c11 c6"></span></p><a id="t.612d797f709ab544362eac4241f37fb5a149edd3"></a><a
        id="t.3"></a>
    <table class="c17">
        <tr class="c13">
            <td class="c18" colspan="1" rowspan="1">
                <p class="c15"><span class="c6 c9">const</span><span class="c1">&nbsp;request =
                        indexedDB.open(</span><span class="c5">&quot;test&quot;</span><span class="c1">, </span><span
                        class="c6 c8">6</span><span class="c1">); </span><span class="c0">// Ne conect&#259;m la baza de
                        date &quot;test&quot;</span><span class="c1"><br><br></span><span class="c0">// La crearea sau
                        modificarea versiunii bazei de date, cre&#259;m depozitul &quot;users&quot;</span><span
                        class="c1"><br>request.onupgradeneeded = (event) =&gt; { <br> &nbsp; &nbsp;</span><span
                        class="c6 c9">const</span><span class="c1">&nbsp;db = event.target.result; &nbsp;</span><span
                        class="c0">// Ob&#539;inem baza de date</span><span class="c1"><br> &nbsp; &nbsp;</span><span
                        class="c0">// Recre&#259;m depozitul &quot;users&quot; - &icirc;l &#537;tergem mai
                        &icirc;nt&acirc;i dac&#259; exist&#259;</span><span class="c1"><br> &nbsp;
                        &nbsp;db.deleteObjectStore(</span><span class="c5">&quot;users&quot;</span><span
                        class="c1">);<br> &nbsp; &nbsp;</span><span class="c0">// Cheia este proprietatea
                        &quot;id&quot;, &#537;i este autoincrementat&#259;</span><span class="c1"><br> &nbsp;
                        &nbsp;</span><span class="c6 c9">const</span><span class="c1">&nbsp;userStore =
                        db.createObjectStore(</span><span class="c5">&quot;users&quot;</span><span class="c1">, {
                        keyPath: </span><span class="c5">&quot;id&quot;</span><span class="c1">, autoIncrement:
                    </span><span class="c6 c9">true</span><span class="c1">&nbsp;});<br> &nbsp;
                        &nbsp;userStore.add({name: </span><span class="c5">&quot;Tom&quot;</span><span class="c1">, age:
                    </span><span class="c6 c8">39</span><span class="c1">});<br> &nbsp; &nbsp;userStore.add({name:
                    </span><span class="c5">&quot;Bob&quot;</span><span class="c1">, age: </span><span
                        class="c6 c8">43</span><span class="c1">});<br> &nbsp; &nbsp;userStore.add({name: </span><span
                        class="c5">&quot;Sam&quot;</span><span class="c1">, age: </span><span
                        class="c6 c8">28</span><span class="c1">});<br>};<br></span><span class="c0">// La deschiderea
                        bazei de date</span><span class="c1"><br>request.onsuccess = (event) =&gt; { <br> &nbsp;
                        &nbsp;</span><span class="c6 c9">const</span><span class="c1">&nbsp;db = event.target.result;
                        &nbsp;</span><span class="c0">// Ob&#539;inem baza de date</span><span class="c1"><br> &nbsp;
                        &nbsp;</span><span class="c6 c9">const</span><span class="c1">&nbsp;transaction =
                        db.transaction([</span><span class="c5">&quot;users&quot;</span><span class="c1">]);
                    </span><span class="c0">// Cre&#259;m o tranzac&#539;ie</span><span class="c1"><br> &nbsp;
                        &nbsp;</span><span class="c6 c9">const</span><span class="c1">&nbsp;userStore =
                        transaction.objectStore(</span><span class="c5">&quot;users&quot;</span><span class="c1">);
                        &nbsp; </span><span class="c0">// Ob&#539;inem depozitul &quot;users&quot;</span><span
                        class="c1"><br> &nbsp; &nbsp;</span><span class="c6 c9">const</span><span
                        class="c1">&nbsp;cursorRequest = userStore.openCursor(); </span><span class="c0">// Ob&#539;inem
                        o solicitare pentru deschiderea unui cursor</span><span class="c1"><br> &nbsp;
                        &nbsp;</span><span class="c6 c9">const</span><span class="c1">&nbsp;users = []; &nbsp;
                    </span><span class="c0">// Array &icirc;n care citim datele</span><span class="c1"><br> &nbsp;
                        &nbsp;</span><span class="c0">// Ob&#539;inem cursorul</span><span class="c1"><br> &nbsp;
                        &nbsp;cursorRequest.onsuccess = () =&gt; {<br> &nbsp; &nbsp; &nbsp; &nbsp;</span><span
                        class="c6 c9">const</span><span class="c1">&nbsp;cursor = cursorRequest.result; &nbsp;
                        &nbsp;</span><span class="c0">// De asemenea, poate fi ob&#539;inut prin
                        event.target.result</span><span class="c1"><br> &nbsp; &nbsp; &nbsp; &nbsp;</span><span
                        class="c6 c9">if</span><span class="c1">(cursor){ &nbsp; &nbsp; </span><span class="c0">//
                        Dac&#259; mai sunt date de citit</span><span class="c1"><br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
                        &nbsp;</span><span class="c6 c9">const</span><span class="c1">&nbsp;user = cursor.value;<br>
                        &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;users.push(user); &nbsp; &nbsp;</span><span
                        class="c0">// Ad&#259;ug&#259;m obiectul ob&#539;inut &icirc;n array</span><span class="c1"><br>
                        &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;cursor.continue(); &nbsp;</span><span class="c0">//
                        Mut&#259;m cursorul la urm&#259;toarea &icirc;nregistrare</span><span class="c1"><br> &nbsp;
                        &nbsp; &nbsp; &nbsp;}<br> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c6 c9">else</span><span
                        class="c1">{<br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span
                        class="c6 c10">console</span><span class="c1">.log(users); &nbsp; &nbsp; </span><span
                        class="c0">// Dac&#259; nu mai sunt &icirc;nregistr&#259;ri de citit, afi&#537;&#259;m
                        array-ul</span><span class="c1"><br> &nbsp; &nbsp; &nbsp; &nbsp;}<br> &nbsp; &nbsp;}<br> &nbsp;
                        &nbsp;cursorRequest.onerror = () =&gt; &nbsp;</span><span class="c6 c10">console</span><span
                        class="c1">.log(cursorRequest.error);<br>};</span></p>
            </td>
        </tr>
    </table>
    <p class="c3"><span class="c11 c6"></span></p>
    <p class="c12"><span class="c11 c6">&Icirc;n acest caz, c&acirc;t timp exist&#259; date de citit, le citim &#537;i
            le ad&#259;ug&#259;m &icirc;n array-ul users. C&acirc;nd toate datele au fost citite, afi&#537;&#259;m
            array-ul pe consol&#259;.</span></p>
    <p class="c3"><span class="c11 c6"></span></p>
</body>

</html>