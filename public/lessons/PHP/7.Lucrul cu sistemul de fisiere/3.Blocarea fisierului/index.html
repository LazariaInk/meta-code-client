<html>
  <head>
    <meta content="text/html; charset=UTF-8" http-equiv="content-type" />
    <link rel="stylesheet" type="text/css" href="/lessons/styles.css">
  </head>
  <body class="c15 doc-content">
    <h1 class="c3 c17">Blocarea fișierului. Funcția flock.</h1>
    <p class="c2"><span class="c4"></span></p>
    <p class="c3">
      <span class="c4"
        >Dac&#259; site-ul nostru este vizitat de mul&#539;i utilizatori care
        acceseaz&#259; simultan acela&#537;i fi&#537;ier, putem
        &icirc;nt&acirc;mpina unele probleme. &Icirc;n special, la
        &icirc;ncercarea simultan&#259; de scriere a mai multor utilizatori,
        fi&#537;ierul poate fi corupt sau poate returna rezultate
        nea&#537;teptate dac&#259; o persoan&#259; cite&#537;te fi&#537;ierul
        &icirc;n timp ce alta &icirc;l scrie simultan. Apare problema
        sincroniz&#259;rii accesului utilizatorilor.</span
      >
    </p>
    <p class="c2"><span class="c4"></span></p>
    <p class="c3">
      <span class="c8"
        >Pentru a limita accesul la fi&#537;ier, &icirc;n PHP se folose&#537;te
        func&#539;ia</span
      ><span class="c10">&nbsp;flock()</span
      ><span class="c4"
        >. Aceast&#259; func&#539;ie blocheaz&#259; accesul la fi&#537;ier
        c&acirc;nd acesta este deja utilizat de un utilizator, iar toate
        celelalte cereri sunt puse &icirc;n a&#537;teptare. La eliberarea
        fi&#537;ierului, acesta se deblocheaz&#259;, se transmite primului
        utilizator din coad&#259; &#537;i se blocheaz&#259; din nou.</span
      >
    </p>
    <p class="c2"><span class="c4"></span></p>
    <p class="c3">
      <span class="c4">Func&#539;ia are urm&#259;toarea defini&#539;ie:</span>
    </p>
    <p class="c2"><span class="c4"></span></p>
    <a id="t.c52f6f872c53c5e6bde462f320dc029cfe55e3c1"></a><a id="t.0"></a>
    <table class="c13">
      <tr class="c12">
        <td class="c7" colspan="1" rowspan="1">
          <p class="c14">
            <span class="c0"
              >bool flock (resource $handle , int $operation [, int
              &amp;$wouldblock ])</span
            >
          </p>
        </td>
      </tr>
    </table>
    <p class="c2"><span class="c4"></span></p>
    <p class="c3">
      <span class="c8"
        >Primul parametru este descriptorul fi&#537;ierului, returnat de
        func&#539;ia</span
      ><span class="c10">&nbsp;fopen()</span><span class="c4">.</span>
    </p>
    <p class="c2"><span class="c4"></span></p>
    <p class="c3">
      <span class="c4"
        >Al doilea parametru indic&#259; tipul bloc&#259;rii. Acesta poate avea
        urm&#259;toarele valori:</span
      >
    </p>
    <p class="c2"><span class="c4"></span></p>
    <p class="c3">
      <span class="c8">-</span><span class="c10">&nbsp;LOCK_SH</span
      ><span class="c4"
        >&nbsp;(sau num&#259;rul 1): blocare partajat&#259; (citirea
        fi&#537;ierului)</span
      >
    </p>
    <p class="c2"><span class="c4"></span></p>
    <p class="c3">
      <span class="c8">- </span><span class="c10">LOCK_EX</span
      ><span class="c4"
        >&nbsp;(sau num&#259;rul 2): blocare exclusiv&#259; (scrierea
        fi&#537;ierului)</span
      >
    </p>
    <p class="c2"><span class="c4"></span></p>
    <p class="c3">
      <span class="c8">- </span><span class="c10">LOCK_UN</span
      ><span class="c4">&nbsp;(sau num&#259;rul 3): pentru deblocare</span>
    </p>
    <p class="c2"><span class="c4"></span></p>
    <p class="c3">
      <span class="c8">- </span><span class="c10">LOCK_NB</span
      ><span class="c8"
        >&nbsp;(sau num&#259;rul 4): aceast&#259; constant&#259; se
        folose&#537;te doar &icirc;mpreun&#259; cu una dintre cele precedente
        &icirc;ntr-o masc&#259; de bi&#539;i (LOCK_EX | LOCK_NB), dac&#259; nu
        trebuie s&#259; a&#537;tept&#259;m p&acirc;n&#259; c&acirc;nd </span
      ><span class="c8 c11">flock()</span
      ><span class="c4">&nbsp;ob&#539;ine blocarea</span>
    </p>
    <p class="c2"><span class="c4"></span></p>
    <p class="c3">
      <span class="c8">Al treilea parametru op&#539;iona</span
      ><span class="c8 c11">l $wouldblock</span
      ><span class="c8">&nbsp;va con&#539;ine </span
      ><span class="c8 c11">true </span
      ><span class="c4">dac&#259; blocarea va fi una blocant&#259;.</span>
    </p>
    <p class="c2"><span class="c4"></span></p>
    <p class="c3">
      <span class="c8">La execu&#539;ia cu succes, func&#539;ia </span
      ><span class="c8 c11">flock </span
      ><span class="c8">va returna valoarea </span
      ><span class="c8 c11">true</span
      ><span class="c8">, iar &icirc;n caz de eroare - </span
      ><span class="c8 c11">false</span><span class="c4">.</span>
    </p>
    <p class="c2"><span class="c4"></span></p>
    <p class="c3">
      <span class="c4"
        >Folosim flock pentru a limita accesul la fi&#537;ier:</span
      >
    </p>
    <p class="c2"><span class="c4"></span></p>
    <a id="t.6216d65669df693a717d983661c5ff70d7a0124f"></a><a id="t.1"></a>
    <table class="c13">
      <tr class="c12">
        <td class="c7" colspan="1" rowspan="1">
          <p class="c14">
            <span class="c1">&lt;?php</span
            ><span class="c0"><br />$fd = fopen(</span
            ><span class="c6">&quot;hello.txt&quot;</span
            ><span class="c0">, </span><span class="c6">&#39;r+&#39;</span
            ><span class="c0">) </span><span class="c9">or</span
            ><span class="c0">&nbsp;</span><span class="c9">die</span
            ><span class="c0">(</span
            ><span class="c6"
              >&quot;Eroare la deschiderea fi&#537;ierului&quot;</span
            ><span class="c0">);<br />$str = </span
            ><span class="c6">&quot;Hello World!&quot;</span
            ><span class="c0"
              >;<br />
              <br /></span
            ><span class="c9">if</span
            ><span class="c0">&nbsp;(flock($fd, LOCK_EX)) </span
            ><span class="c5"
              >// setarea bloc&#259;rii exclusive pentru scriere</span
            ><span class="c0"
              ><br />{<br />
              &nbsp; &nbsp;fseek($fd, </span
            ><span class="c16">0</span><span class="c0">, SEEK_END); </span
            ><span class="c5"
              >// plasarea indicatorului la sf&acirc;r&#537;itul
              fi&#537;ierului</span
            ><span class="c0"
              ><br />
              &nbsp; &nbsp;fwrite($fd, </span
            ><span class="c6">&quot;$str&quot;</span><span class="c0">) </span
            ><span class="c9">or</span><span class="c0">&nbsp;</span
            ><span class="c9">die</span><span class="c0">(</span
            ><span class="c6">&quot;Eroare la scriere&quot;</span
            ><span class="c0">); </span><span class="c5">// scrierea</span
            ><span class="c0"
              ><br />
              &nbsp; &nbsp;flock($fd, LOCK_UN); </span
            ><span class="c5">// deblocarea fi&#537;ierului</span
            ><span class="c0"><br />}<br />fclose($fd);<br /></span
            ><span class="c1">?&gt;</span>
          </p>
        </td>
      </tr>
    </table>
    <p class="c2"><span class="c4"></span></p>
    <p class="c3">
      <span class="c8"
        >La modificarea fi&#537;ierului, blocarea este plasat&#259; chiar
        &icirc;nainte de a face modific&#259;rile &#537;i se elimin&#259;
        imediat dup&#259; efectuarea acestora. &Icirc;n caz contrar, programul
        poate &icirc;ncetini. De aceea, apelul care blocheaz&#259;
        fi&#537;ierul: </span
      ><span class="c8 c11">flock($fd, LOCK_EX) </span
      ><span class="c8"
        >este plasat chiar &icirc;nainte de apelul func&#539;iei </span
      ><span class="c8 c11">fwrite($fd, &quot;$str&quot;)</span
      ><span class="c8">. Iar deblocarea cu ajutorul constantei </span
      ><span class="c8 c11">LOCK_UN</span
      ><span class="c4">&nbsp;are loc imediat dup&#259; scriere.</span>
    </p>
    <p class="c2"><span class="c4"></span></p>
    <p class="c3">
      <span class="c4"
        >Re&#539;ine&#539;i c&#259; la deschiderea fi&#537;ierului s-a folosit
        modul &#39;r+&#39;, nu &#39;w&#39; sau &#39;w+&#39;, deoarece
        &#39;w&#39; &#537;i &#39;w+&#39; implic&#259; deja modificarea
        fi&#537;ierului. Prin urmare, la blocare, chiar dac&#259; trebuie
        f&#259;cut&#259; scrierea, nu este recomandat&#259; utilizarea
        &#39;w&#39; &#537;i &#39;w+&#39;.</span
      >
    </p>
    <p class="c2"><span class="c4"></span></p>
    <p class="c3">
      <span class="c8"
        >Dac&#259; trebuie s&#259; &#537;tergem tot con&#539;inutul
        fi&#537;ierului &#537;i s&#259;-l rescriem, putem folosi func&#539;ia </span
      ><span class="c10">ftruncate</span><span class="c4">:</span>
    </p>
    <p class="c2"><span class="c4"></span></p>
    <a id="t.d88ba172e66738ae8d1ebf8c28621a820fd84e3c"></a><a id="t.2"></a>
    <table class="c13">
      <tr class="c12">
        <td class="c7" colspan="1" rowspan="1">
          <p class="c14">
            <span class="c1">&lt;?php</span
            ><span class="c0"><br />$fd = fopen(</span
            ><span class="c6">&quot;hello.txt&quot;</span
            ><span class="c0">, </span><span class="c6">&#39;r+&#39;</span
            ><span class="c0">) </span><span class="c9">or</span
            ><span class="c0">&nbsp;</span><span class="c9">die</span
            ><span class="c0">(</span
            ><span class="c6"
              >&quot;Eroare la deschiderea fi&#537;ierului&quot;</span
            ><span class="c0">);<br />$str = </span
            ><span class="c6">&quot;Hello World!&quot;</span
            ><span class="c0"
              >;<br />
              <br /></span
            ><span class="c9">if</span
            ><span class="c0">&nbsp;(flock($fd, LOCK_EX)) </span
            ><span class="c5"
              >// setarea bloc&#259;rii exclusive pentru scriere</span
            ><span class="c0"
              ><br />{<br />
              &nbsp; &nbsp;ftruncate($fd, </span
            ><span class="c16">0</span><span class="c0">); </span
            ><span class="c5"
              >// &#537;tergerea con&#539;inutului fi&#537;ierului</span
            ><span class="c0"
              ><br />
              &nbsp; &nbsp;fwrite($fd, </span
            ><span class="c6">&quot;$str&quot;</span><span class="c0">) </span
            ><span class="c9">or</span><span class="c0">&nbsp;</span
            ><span class="c9">die</span><span class="c0">(</span
            ><span class="c6">&quot;Eroare la scriere&quot;</span
            ><span class="c0">); </span><span class="c5">// scrierea</span
            ><span class="c0"
              ><br />
              &nbsp; &nbsp;flock($fd, LOCK_UN); </span
            ><span class="c5">// deblocarea fi&#537;ierului</span
            ><span class="c0"><br />}<br />fclose($fd);<br /></span
            ><span class="c1">?&gt;</span>
          </p>
        </td>
      </tr>
    </table>
    <p class="c2"><span class="c4"></span></p>
    <p class="c3">
      <span class="c4"
        >Astfel, ne asigur&#259;m c&#259; fi&#537;ierul este blocat &icirc;n mod
        exclusiv &icirc;nainte de &#537;tergere &#537;i scriere, &#537;i
        deblocat imediat dup&#259;.</span
      >
    </p>
    <p class="c2"><span class="c4"></span></p>
  </body>
</html>
